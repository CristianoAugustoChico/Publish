$(function(){function e(e,n,t){var i=$('<div style="height:25px;">');n.endsWith(".png")?i.append($('<div class="legend-img-box">').css("background-image","url("+n+")")):i.append($('<div class="legend-color-box">').css({backgroundColor:n})),i.append($("<span>").css("lineHeight","23px").html(t)),e.append(i)}function n(n){te.empty(),ue.text(" "+Publish.legend);var t=[];$.each(n,function(e){t.push(e)}),t.sort(),$.each(t,function(t,i){var o=n[i];e(te,o,i)})}function t(e,t){var i=e.label,o=t||"Description",a=e.description.split("."),r=a[0]?a[0]+".":"",l=We+40,s=40*(De-l)/100,c=20*(De-l)/100;xe.height()<s&&(c=30*(De-l)/100),xe.css("max-height",s),le.css("max-height",c),se.css("max-height",c),a.length-1>1?Pe.show():Pe.hide(),ce.text(" "+o),re.text(r||""),$e.text(" "+o),ye.text(e.description||""),n(i)}function i(e){return{fillColor:e.getProperty("color"),strokeColor:e.getProperty("border"),strokeWeight:e.getProperty("width"),zIndex:e.getProperty("order"),icon:e.getProperty("icon")}}function o(e){var n=e.color;if(e.slices){var t=Object.keys(n).sort(function(e,n){return e-n}),i=t.map(Number);return function(e){var o=null;return $.each(i,function(i,a){e>=a&&(o=n[t[i]])}),o}}return function(e){return n[e]}}function a(e,n,t){var i=t.geom||e.getGeometry().getType(),a=K(t,1),r=o(t);if(!t.icon||i!==_e.Point&&i!==_e.MultiPoint){var l=a||n,s=t.color;"object"===$.type(s)?e.setProperty("color",r(e.getProperty(l))):e.setProperty("color",s),e.setProperty("border",t.border),e.setProperty("width",t.width)}else{var c=t.icon.options[e.getProperty(a)];c||(c=t.icon.path),e.setProperty("icon",c)}e.setProperty("order",t.order)}function r(e,n,t){e.setStyle(i),t.report&&e.addListener("click",function(e){if("function"===t.report){var i=e.feature.getProperty(K(t,0));"string"===$.type(i)&&(i=i.replace(/\s/g,"")),$("#modal-report-"+n+i).modal("show")}else $("#modal-report-"+n).modal("show")}),ee[n]=e}function l(e,n,t){$.each(n,function(n,i){i.getVisible()?x(e,i):(P(e,i,t),g(e,le.hasClass("in"),se.hasClass("in")))})}function s(e){return e.geom===_e.LineString}function c(e){return e.geom===_e.MultiLineString}function u(e){return s(e)||c(e)}function p(e,n,t){var i=n.time?n.id:e;if("WMS"===n.geom){var o=new $.Deferred,a=new geoambiente.maps.WmsLayer({url:n.url,layer:n.name,visibility:n.visible,opacity:n.transparency,map:Q});return o.resolve(a),ee[e]=a,n.visible&&q(i,!0),t&&t(a),o.promise()}var r=Publish.path+e+".geojson";return $.getJSON(r,function(o){var a=new google.maps.Data;a.addGeoJson(o),u(n)?C(a,e,n):(M(a,e,n),n.visible&&(a.setMap(Q),q(i,!0)),t&&t(a))})}function d(e,n){e.setMap(null),q(n,!1)}function f(e,n){e.setMap(Q),q(n,!0),g(n,le.hasClass("in"),se.hasClass("in"))}function h(e,n,t){if(n=n||Publish.data[e],n.time&&!t)$.each(n.name,function(e,t){h(t,n,!0)});else{var i=ee[e];if(i)if(u(n)){var o=n.icon.time;s(n)?l(e,i,o):$.each(i,function(n,t){l(e,t,o)})}else{var a=n.time?n.id:e;n.geom===_e.WMS?i.getVisibility()?d(i,a):f(i,a):i.getMap()?d(i,a):f(i,a)}else L(),ae.empty(),S(e,1,1),n.visible=!0,p(e,n).done(function(){g(e,le.hasClass("in"),se.hasClass("in"))}).always(function(){O()})}}function m(e,n){X=null,te.empty(),re.empty(),ce.text(" Description"),de.hide(),$("button").removeClass("button-selected"),e&&(ce.click(),ce.prop("disabled",!0)),n&&(ue.click(),ue.prop("disabled",!0))}function g(e,n,i){X=e;var o=Publish.data[e];if(t(o,ne[e]),n||(ce.prop("disabled",!1),ce.click()),i||(ue.prop("disabled",!1),ue.click()),o.download){var a=e+".zip";pe.prop("href",Publish.path+a),pe.prop("download",a),de.show()}else de.hide();Ie.removeClass("button-selected"),$("#"+e).addClass("button-selected")}function v(e){var n=e.target.id;if(n){var t=le.hasClass("in"),i=se.hasClass("in");X===n?m(t,i):g(n,t,i)}}function b(e){var n=e.target.name;if(n){var t=Publish.group;if(t){var i=Publish.data[n].group,o=t[i];o?(h(o),o===n?t[i]=null:(t[i]=n,h(n))):(t[i]=n,h(n))}else h(n);if(Je){var a=Z();a&&null!==Oe?(Oe.appendTo(Le),Oe=null):a||null!==Oe||(Oe=Se.detach())}}}function y(e,n,t){var i=0,o=setInterval(function(){i=(i+1)%200;var e=n.get("icons");e[0].offset=i/2+"%",n.set("icons",e)},t);window.intervals||(window.intervals={}),window.intervals[e]||(window.intervals[e]=[]),window.intervals[e].push(o)}function w(e,n){var t=e.icon.options,i=[];n.forEachLatLng(function(e){i.push(e)});var o={path:t.path,anchor:new google.maps.Point(175,175),scale:.1,fillColor:t.fillColor,fillOpacity:t.fillOpacity,strokeWeight:t.strokeWeight},a={path:i,icons:[{icon:o}],strokeWeight:e.width,strokeColor:e.border||e.color,strokeOpacity:e.transparency};return new google.maps.Polyline(a)}function P(e,n,t){n.setMap(Q),n.setVisible(!0),y(e,n,t)}function x(e,n){n.setMap(null),n.setVisible(!1),window.intervals&&$.each(window.intervals[e],function(e,n){clearInterval(n)})}function C(e,n,t){var i=[],o=t.visible,a=t.icon.time;e.forEach(function(e){var r=e.getGeometry();if(s(t)){var l=w(t,r);i.push(l),o&&P(n,l,a)}else if(c(t)){var u=[];$.each(r.getArray(),function(e,i){var r=w(t,i);u.push(r),o&&P(n,r,a)}),i.push(u)}}),ee[n]=i,o&&q(n,!0)}function M(e,n,t){e.forEach(function(e){a(e,n,t)}),r(e,n,t)}function k(e,n,t){return"Loading"+ne[e]+" ("+n+"/"+t+")"}function S(e,n,t){var i=k(e,n,t);ae.text(i)}function L(){ie.fadeIn(),oe.css("z-index",1e7)}function O(){ie.fadeOut(),ae.empty(),oe.css("z-index",-1)}function z(e,n){function t(e,n,t){return Math.floor(Math.log(e/n/t)/Math.LN2)}if("number"===$.type(e))return e;var i=t(De,e.yTile,e.latFraction),o=t(we.width(),e.xTile,e.longFraction);return Math.min(i,o,n)}function T(e){var n=[];return $.each(e,function(e,t){n.push(t)}),n}function I(e){var n=[],t=0,i=Object.keys(e).length,o=!1;L(),$.each(e,function(e,l){U(l);var s=l.visible,c=l.time;if(!s&&!c)return!0;if(t+=1,ae.empty(),S(e,t,i),c){var u=0;if("creation"===c){var d=Publish.path+e+".geojson";n.push($.getJSON(d,function(n){var t=new google.maps.Data;t.addGeoJson(n);var i={};$.each(l.timeline,function(e,n){i[n]=new google.maps.Data});var o=l.name;t.forEach(function(n){a(n,e,l);var t=n.getProperty(o),r=i[t];r&&r.add(n)}),l.name=[],$.each(i,function(n,t){var i=e+"_"+n;r(t,i,l),j(n,t,e,c),l.name.push(i),u++,s&&(t.setMap(Q),q(e,!0))})}))}else $.each(l.name,function(t,i){var o=l.timeline[u];n.push(p(i,l,function(n){j(o,n,e,c)})),u++});!Je&&s&&(Je=!0,o=!0)}else n.push(p(e,l))});var l=le.hasClass("in"),s=se.hasClass("in");g(Ie[0].id,l,s),$.when.apply($,n).always(function(){o&&Je&&(D(),Ye.timelineYears=T(Ge),Ye.timelineLayers=T(Ve),Ye.backup=T(Ge)),O()})}function W(){google.maps.visualRefresh=!0;var e={center:new google.maps.LatLng(Publish.center.lat,Publish.center.long),zoom:z(Publish.zoom,Publish.maxZoom),minZoom:Publish.minZoom,maxZoom:Publish.maxZoom,mapTypeId:google.maps.MapTypeId[Publish.mapTypeId],mapTypeControl:!0,mapTypeControlOptions:{style:google.maps.MapTypeControlStyle.DROPDOWN_MENU,position:google.maps.ControlPosition.TOP_RIGHT}};Q=new google.maps.Map(we[0],e),Q.controls[google.maps.ControlPosition.BOTTOM_RIGHT].push($("#footer")[0]),H(),google.maps.event.addListenerOnce(Q,"idle",function(){I(Publish.data)})}function D(){ke.slider({range:!0,min:0,max:Ge.length-1,step:1,values:[0,Ge.length-1]}).each(N).on("slide",G)}function V(e){$.each(Ve,function(n,t){var i=null;je[t.type]&&t.year===Ge[e]&&(i=Q),t.layer.setMap(i)})}function G(e,n){var t=Ge.length-1;ze.css("left",n.values[1]/t*100+"%"),Ne=n.values,V(n.values[1])}function N(){var e=Ge.length-1,n=0;Ne=[0,Ge.length-1],$.each(Ge,function(t,i){var o=$("<label>"+i+"</label>").css("left",n/e*100+"%");ke.append(o),n++})}function j(e,n,t,i,o){var a=J(e),r=Y(e);a?E(t,n,e,i,o):(Ge.splice(r,0,e),E(t,n,e,i,o))}function E(e,n,t,i,o){Ve.push({type:e,layer:n,year:t,time:i,scenario:o})}function Y(e){var n=0;return $.each(Ge,function(t,i){return i===e?t:e<i?t:void n++}),n}function Z(){var e=!1;return Je&&Ve.length>0&&$.each(Ve,function(n,t){if(je[t.type])return e=!0,!1}),e}function J(e){var n=!1;return $.each(Ge,function(t,i){i===e&&(n=!0)}),n}function R(){Me.prop("disabled",!0),ke.slider("disable");var e=Ge.length-1,n=Ne[0],t=null;t=setInterval(function(){n<=Ne[1]?(ze.css("left",n/e*100+"%"),V(n),n++):(clearInterval(t),Me.prop("disabled",!1),ke.slider("enable"))},1e3)}function _(){if(Ye.currentScenario){var e=Publish.data[Ye.currentView],n=e.scenario[Ye.currentScenario];$.each(n.name,function(e,n){ee[n].setMap(null)}),$.each(n.timeline,function(e,n){var t=Ge.indexOf(n);t>=0&&Ge.splice(t,1)})}}function F(){_();var e=Te.find("option:selected").text(),n=Te.find("option:selected").val();if(n){var t=Ze[e];if(t)Ge=T(t.timelineYears),Ve=T(t.timelineLayers),Ye.currentScenario=e,Ye.currentView=n,ke.find("label").remove(),D();else{var i=[],o=Publish.data[n],a=o.scenario[e];L(),ae.empty(),S(e,1,1);var r=0,l=o.time;$.each(a.name,function(t,s){var c=a.timeline[r];i.push(p(s,o,function(t){j(c,t,n,l,e)})),r++,Re||(Re=!0)}),$.when.apply($,i).always(function(){Ye.currentScenario=e,Ye.currentView=n,Ze[e]={timelineYears:T(Ge),timelineLayers:T(Ve)},ke.find("label").remove(),D(),O()})}}else Ge=T(Ye.timelineYears),Ve=T(Ye.timelineLayers),Ye.currentScenario=null,Ye.currentView=null,$.each(Ge,V),ke.find("label").remove(),D()}function H(){var e=Ce.find("input");e.each(function(e,n){Ee[n.name]=$(n)}),Ie.each(function(e,n){ne[n.id]=n.innerText,je[n.id]=!1}),e.click(b),Ie.click(v),Me.click(R),Te.change(F),ce.prop("disabled",!0),ue.prop("disabled",!0),de.hide()}function A(){if(fe.is(":visible"))we.find(".ol-zoom").css("margin-left",0).removeClass("zoom-top-opened-sidebar").addClass("zoom-top-collapsed");else{var e=$(".sidebar-left");we.find(".ol-zoom").css("margin-left",e.width()).removeClass("zoom-top-opened-sidebar").removeClass("zoom-top-collapsed")}}function B(){return he.width()===$(window).width()}function U(e){if(!e.label){e.label={};e.label[e.id]=e.color||e.border||"rgba(0, 0, 0, 1)"}}function q(e,n){je[e]!==n&&(je[e]=n,Ee[e].prop("checked",n))}function K(e,n){return"array"===$.type(e.select)?e.select[n]:e.select}var Q,X,ee={},ne={},te=$("#legend"),ie=$("#loader"),oe=$("#loader-message"),ae=$("#loader-message-text"),re=$("#layer-description"),le=$("#properties"),se=$("#legends"),ce=$("#description-title"),ue=$("#legend-title"),pe=$("#download-title"),de=$("#panel-download"),fe=$(".mini-submenu-left"),he=$(".sidebar"),me=$(".sidebar-left .sidebar-body"),ge=$(".sidebar-left .slide-submenu"),ve=$("#modal-app-description"),be=$("#modal-completed-description"),$e=$("#modal-title-description"),ye=$("#info-description"),we=$("#map"),Pe=$("#more"),xe=$("#layers"),Ce=xe.find("label"),Me=$("#play"),ke=$("#slider"),Se=$("#slider-container"),Le=$("#slider-col"),Oe=null,ze=$("#spanSelectedYear"),Te=$("#scenario-combobox"),Ie=Ce.find("a"),We=$(".navbar").height(),De=we.height(),Ve=[],Ge=[],Ne=[],je={},Ee={},Ye={},Ze={},Je=!1,Re=!1,_e={Point:"Point",MultiPoint:"MultiPoint",LineString:"LineString",MultiLineString:"MultiLineString",WMS:"WMS"};google.maps.event.addDomListener(window,"load",W),ge.on("click",function(){$(this).closest(".sidebar-body").fadeOut("slide",function(){fe.fadeIn(),A()})}),fe.on("click",function(){var e=$(this);me.toggle("slide"),e.hide(),A()}),Pe.on("click",function(){be.modal("show")}),$(window).on("resize",A),ve.modal("show"),function(){if(B()&&(me.fadeOut("slide"),fe.fadeIn()),$("#logo")){var e=We-50;$("body").css("padding-top",e),fe.css("margin-top",e)}var n=Publish.fontSize;if(n){var t=$(".custom-font-layer"),i=$(".custom-font-app-title"),o=$(".custom-font-group-title"),a=$(".custom-font-report-title"),r=$(".custom-font-subtitle"),l=$(".custom-font-body"),s=$(".custom-font-legend"),c=$(".custom-font-more "),u=function(e){return parseFloat(e.css("font-size"))},p=function(e,n){e.css("font-size",n+"px")},d=u(t),f=function(e){var t=u(e)-d;p(e,n+t)};p(t,n),f(i),f(o),f(a),f(r),f(l),f(s),f(c)}}(),A()});