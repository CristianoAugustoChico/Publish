$(function(){function e(e,n,t){var i=$('<div style="height:25px;">');n.endsWith(".png")?i.append($('<div class="legend-img-box">').css("background-image","url("+n+")")):i.append($('<div class="legend-color-box">').css({backgroundColor:n})),i.append($("<span>").css("lineHeight","23px").html(t)),e.append(i)}function n(n){le.empty(),me.text(" "+Publish.legend);var t=[];$.each(n,function(e){t.push(e)}),t.sort(),$.each(t,function(t,i){var o=n[i];e(le,o,i)})}function t(e,t){var i=e.label,o=t||"Description",r=e.description||"",a=r.split("."),l=a[0]?a[0]+".":"",s=_e+40,c=40*(Fe-s)/100,u=20*(Fe-s)/100;Le.height()<c&&(u=30*(Fe-s)/100),Le.css("max-height",c),pe.css("max-height",u),fe.css("max-height",u),a.length-1>1?Se.show():Se.hide(),he.text(" "+o),de.text(l),Ce.text(" "+o),ke.text(r),n(i)}function i(e){return{fillColor:e.getProperty("color"),strokeColor:e.getProperty("border"),strokeWeight:e.getProperty("width"),zIndex:e.getProperty("order"),icon:e.getProperty("icon")}}function o(e){var n=e.color;if(e.slices){var t=Object.keys(n).sort(function(e,n){return e-n}),i=t.map(Number);return function(e){var o=null;return $.each(i,function(i,r){e>=r&&(o=n[t[i]])}),o}}return function(e){return n[e]}}function r(e,n,t){var i=t.geom||e.getGeometry().getType(),r=te(t,1),a=o(t);if(!t.icon||i!==on.Point&&i!==on.MultiPoint){var l=r||n,s=t.color;"object"===$.type(s)?e.setProperty("color",a(e.getProperty(l))):e.setProperty("color",s),e.setProperty("border",t.border),e.setProperty("width",t.width)}else{var c=t.icon.options[e.getProperty(r)];c||(c=t.icon.path),e.setProperty("icon",c)}e.setProperty("order",t.order)}function a(e,n,t){e.setStyle(i),t.report&&e.addListener("click",function(e){if("function"===t.report){var i=e.feature.getProperty(te(t,0));"string"===$.type(i)&&(i=i.replace(/\s/g,"")),$("#modal-report-"+n+i).modal("show")}else $("#modal-report-"+n).modal("show")}),re[n]=e}function l(e,n,t){$.each(n,function(n,i){i.getVisible()?S(e,i):(M(e,i,t),w(e,pe.hasClass("in"),fe.hasClass("in")))})}function s(e){return e.geom===on.LineString}function c(e){return e.geom===on.MultiLineString}function u(e){return s(e)||c(e)}function d(e,n,t){var i=n.visible,o=n.time?n.id:e;if("WMS"===n.geom){var r=new $.Deferred,a=n.time?e:n.name,l=new geoambiente.maps.WmsLayer({url:n.url,layer:a,visibility:i,opacity:n.transparency,map:ie});return r.resolve(l),re[e]=l,i&&ne(o,!0),t&&t(l),r.promise()}var s=Publish.path+e+".geojson";return $.getJSON(s,function(r){var a=new google.maps.Data;a.addGeoJson(r),u(n)?L(a,e,n):(O(a,e,n),i&&(a.setMap(ie),ne(o,!0)),t&&t(a))})}function p(e,n){e.setMap(null),ne(n,!1)}function f(e,n){e.setMap(ie),ne(n,!0),w(n,pe.hasClass("in"),fe.hasClass("in"))}function h(){var e=Ae[0],n=Ae[1];if(null!==e&&void 0!==e&&null!==n&&void 0!==n)for(var t=e;t<=n;t++)E(t)}function m(e,n,t){var i=e.icon.time;s(e)?l(n,t,i):$.each(t,function(e,t){l(n,t,i)})}function v(e,n){Ue[e]?p(n,e):f(n,e)}function g(e){Ue[e]?ne(e,!1):(ne(e,!0),w(e,pe.hasClass("in"),fe.hasClass("in"))),h()}function b(e){var n=Publish.data[e];if(n.time)g(e);else{var t=re[e];t?u(n)?m(n,e,t):v(e,t):(I(),ue.empty(),T(e,1,1),n.visible=!0,d(e,n).done(function(){w(e,pe.hasClass("in"),fe.hasClass("in"))}).always(function(){W()}))}}function y(e,n){oe=null,le.empty(),de.empty(),he.text(" Description"),ge.hide(),$("button").removeClass("button-selected"),e&&(he.click(),he.prop("disabled",!0)),n&&(me.click(),me.prop("disabled",!0))}function w(e,n,i){oe=e;var o=Publish.data[e];if(t(o,ae[e]),n||(he.prop("disabled",!1),he.click()),i||(me.prop("disabled",!1),me.click()),o.download){var r=e+".zip";ve.prop("href",Publish.path+r),ve.prop("download",r),ge.show()}else ge.hide();Te.removeClass("button-selected"),$("#"+e).addClass("button-selected")}function P(e){var n=e.target.id;if(n){var t=pe.hasClass("in"),i=fe.hasClass("in");oe===n?y(t,i):w(n,t,i)}}function x(e){var n=e.target.name;if(n){var t=Publish.group;if(t){var i=Publish.data[n].group,o=t[i];o?(b(o),o===n?t[i]=null:(t[i]=n,b(n))):(t[i]=n,b(n))}else b(n);if(en){var r=F();r&&null!==Ge?(Ge.appendTo(Ve),Ge=null):r||null!==Ge||(Ge=De.detach())}}}function C(e,n,t){var i=0,o=setInterval(function(){i=(i+1)%200;var e=n.get("icons");e[0].offset=i/2+"%",n.set("icons",e)},t);window.intervals||(window.intervals={}),window.intervals[e]||(window.intervals[e]=[]),window.intervals[e].push(o)}function k(e,n){var t=e.icon.options,i=[];n.forEachLatLng(function(e){i.push(e)});var o={path:t.path,anchor:new google.maps.Point(175,175),scale:.1,fillColor:t.fillColor,fillOpacity:t.fillOpacity,strokeWeight:t.strokeWeight},r={path:i,icons:[{icon:o}],strokeWeight:e.width,strokeColor:e.border||e.color,strokeOpacity:e.transparency};return new google.maps.Polyline(r)}function M(e,n,t){n.setMap(ie),n.setVisible(!0),C(e,n,t)}function S(e,n){n.setMap(null),n.setVisible(!1),window.intervals&&$.each(window.intervals[e],function(e,n){clearInterval(n)})}function L(e,n,t){var i=[],o=t.visible,r=t.icon.time;e.forEach(function(e){var a=e.getGeometry();if(s(t)){var l=k(t,a);i.push(l),o&&M(n,l,r)}else if(c(t)){var u=[];$.each(a.getArray(),function(e,i){var a=k(t,i);u.push(a),o&&M(n,a,r)}),i.push(u)}}),re[n]=i,o&&ne(n,!0)}function O(e,n,t){e.forEach(function(e){r(e,n,t)}),a(e,n,t)}function z(e,n,t){return"Loading"+ae[e]+" ("+n+"/"+t+")"}function T(e,n,t){var i=z(e,n,t);ue.text(i)}function I(){se.fadeIn(),ce.css("z-index",1e7)}function W(){se.fadeOut(),ue.empty(),ce.css("z-index",-1)}function D(e,n){function t(e,n,t){return Math.floor(Math.log(e/n/t)/Math.LN2)}if("number"===$.type(e))return e;var i=t(Fe,e.yTile,e.latFraction),o=t(Me.width(),e.xTile,e.longFraction);return Math.min(i,o,n)}function V(e){var n=[];return $.each(e,function(e,t){n.push(t)}),n}function G(e){var n=[],t=0,i=Object.keys(e).length,o=!1;I(),$.each(e,function(e,l){ee(l);var s=l.visible,c=l.time;if(l.scenario&&(Ke[e]=!0,nn||(nn=!0)),!s&&!c)return!0;if(t+=1,ue.empty(),T(e,t,i),c){var u=0;if("creation"===c){var p=Publish.path+e+".geojson";n.push($.getJSON(p,function(n){var t=new google.maps.Data;t.addGeoJson(n);var i={};$.each(l.timeline,function(e,n){i[n]=new google.maps.Data});var o=l.name;t.forEach(function(n){r(n,e,l);var t=n.getProperty(o),a=i[t];a&&a.add(n)}),l.name=[],$.each(i,function(n,t){var i=e+"_"+n;a(t,i,l),J(n,t,e,c),l.name.push(i),u++,s&&(t.setMap(ie),ne(e,!0))})}))}else $.each(l.name,function(t,i){var o=l.timeline[u];n.push(d(i,l,function(n){J(o,n,e,c)})),u++});!en&&s&&(en=!0,o=!0)}else n.push(d(e,l))});var l=pe.hasClass("in"),s=fe.hasClass("in");w(Te[0].id,l,s),$.when.apply($,n).always(function(){o&&en&&(j(),Qe.timelineYears=V(Be),Qe.timelineLayers=V(He),Qe.backup=V(Be)),W()})}function N(){google.maps.visualRefresh=!0;var e={center:new google.maps.LatLng(Publish.center.lat,Publish.center.long),zoom:D(Publish.zoom,Publish.maxZoom),minZoom:Publish.minZoom,maxZoom:Publish.maxZoom,mapTypeId:google.maps.MapTypeId[Publish.mapTypeId],mapTypeControl:!0,mapTypeControlOptions:{style:google.maps.MapTypeControlStyle.DROPDOWN_MENU,position:google.maps.ControlPosition.TOP_RIGHT}};ie=new google.maps.Map(Me[0],e),ie.controls[google.maps.ControlPosition.BOTTOM_RIGHT].push($("#footer")[0]),K(),google.maps.event.addListenerOnce(ie,"idle",function(){G(Publish.data)})}function j(){We.slider({range:!0,min:0,max:Be.length-1,step:1,values:[0,Be.length-1]}).each(Z).on("slide",Y)}function E(e){$.each(He,function(n,t){var i=null;Ue[t.type]&&t.year===Be[e]&&(i=ie),t.layer.setMap(i)})}function Y(e,n){var t=Be.length-1,i=n.values[1],o=i/t*100-1||0;Ne.css("left",o+"%"),Ae=n.values,E(i)}function Z(){var e=0,n=Be.length,t=n-1;if(Ae=[0,t],0===t){var i=$(".ui-slider-handle");$(i[0]).css("left","0%"),$(i[1]).css("left","100%");var o=$("<label> </label>").css("left","0%");We.append(o),o=$("<label>"+Be[0]+"</label>").css("left","100%"),We.append(o)}else $.each(Be,function(n,i){var o=e/t*100||0,r=$("<label>"+i+"</label>").css("left",o+"%");We.append(r),e++});if(n>0){var r=100/n;if(r<6){var a=.6*Me.width(),l=De.width(),s=l*(6/r);s>a&&(s=a),De.width(s)}}}function J(e,n,t,i,o){var r=H(e),a=_(e);r?R(t,n,e,i,o):(Be.splice(a,0,e),R(t,n,e,i,o))}function R(e,n,t,i,o){He.push({type:e,layer:n,year:t,time:i,scenario:o})}function _(e){var n=0;return $.each(Be,function(t,i){return i===e?t:e<i?t:void n++}),n}function F(){var e=!1;return en&&He.length>0&&$.each(He,function(n,t){if(Ue[t.type])return e=!0,!1}),e}function H(e){var n=!1;return $.each(Be,function(t,i){i===e&&(n=!0)}),n}function B(){ze.prop("disabled",!0),Te.off("click"),Ie.prop("disabled",!0),We.slider("disable");var e=Be.length-1,n=Ae[0],t=Ae[1],i=null,o=function(){n<=t?(Ne.css("left",n/e*100-1+"%"),E(n),n++):(clearInterval(i),ze.prop("disabled",!1),Te.click(P),Ie.prop("disabled",!1),We.slider("enable"))};i=setInterval(o,tn)}function A(){var e=!1;return nn&&$.each(Ue,function(n,t){if(t&&Ke[n])return e=!0,!1}),e}function U(){if(Qe.currentScenario){var e=Publish.data[Qe.currentView],n=e.scenario[Qe.currentScenario];$.each(n.name,function(e,n){re[n].setMap(null)}),Be=V(Qe.timelineYears),He=V(Qe.timelineLayers),Qe.currentScenario=null,Qe.currentView=null}}function q(){U();var e=$("#scenarioSeparator"),n=je.find("option:selected").text(),t=je.find("option:selected").val();if(t){0===e.length&&(e=$('<br id="scenarioSeparator"/>'),e.insertBefore(Ee));var i=Xe[n];if(i)Be=V(i.timelineYears),He=V(i.timelineLayers),Qe.currentScenario=n,Qe.currentView=t,We.find("label").remove(),j(),h();else{var o=[],r=Publish.data[t],a=r.scenario[n];I(),ue.empty(),T(n,1,1);var l=0,s=r.time;$.each(a.name,function(e,i){var c=a.timeline[l];o.push(d(i,r,function(e){J(c,e,t,s,n)})),l++}),$.when.apply($,o).always(function(){Qe.currentScenario=n,Qe.currentView=t,Xe[n]={timelineYears:V(Be),timelineLayers:V(He)},We.find("label").remove(),j(),W(),h()})}var c=Publish.scenario[n],u=c.split("."),p=u[0]?u[0]+".":"";u.length-1>1?Ye.show():Ye.hide(),Ee.text(p),Je.text(" "+n),Re.text(c)}else We.find("label").remove(),j(),h(),e.length>0&&e.remove(),Ee.text(""),Ye.hide()}function K(){ze.each(function(e,n){qe[n.name]=$(n)}),Te.each(function(e,n){ae[n.id]=n.innerText,Ue[n.id]=!1}),ze.click(x),Te.click(P),Ie.click(B),je.change(q),he.prop("disabled",!0),me.prop("disabled",!0),ge.hide()}function Q(){if($e.is(":visible"))Me.find(".ol-zoom").css("margin-left",0).removeClass("zoom-top-opened-sidebar").addClass("zoom-top-collapsed");else{var e=$(".sidebar-left");Me.find(".ol-zoom").css("margin-left",e.width()).removeClass("zoom-top-opened-sidebar").removeClass("zoom-top-collapsed")}}function X(){return be.width()===$(window).width()}function ee(e){if(!e.label){e.label={};e.label[e.id]=e.color||e.border||"rgba(0, 0, 0, 1)"}}function ne(e,n){Ue[e]!==n&&(Ue[e]=n,nn&&e===Qe.currentView&&je.val("").change(),qe[e].prop("checked",n)),nn&&(A()?je.prop("disabled",!1):je.prop("disabled",!0))}function te(e,n){return"array"===$.type(e.select)?e.select[n]:e.select}var ie,oe,re={},ae={},le=$("#legend"),se=$("#loader"),ce=$("#loader-message"),ue=$("#loader-message-text"),de=$("#layer-description"),pe=$("#properties"),fe=$("#legends"),he=$("#description-title"),me=$("#legend-title"),ve=$("#download-title"),ge=$("#panel-download"),$e=$(".mini-submenu-left"),be=$(".sidebar"),ye=$(".sidebar-left .sidebar-body"),we=$(".sidebar-left .slide-submenu"),Pe=$("#modal-app-description"),xe=$("#modal-completed-description"),Ce=$("#modal-title-description"),ke=$("#info-description"),Me=$("#map"),Se=$("#more"),Le=$("#layers"),Oe=Le.find("label"),ze=Oe.find("input"),Te=Oe.find("a"),Ie=$("#play"),We=$("#slider"),De=$("#slider-container"),Ve=$("#slider-col"),Ge=null,Ne=$("#spanSelectedYear"),je=$("#scenario-combobox"),Ee=$("#scenario-description"),Ye=$("#more-scenario-description"),Ze=$("#modal-scenario-completed-description"),Je=$("#modal-scenario-title-description"),Re=$("#scenario-info-description"),_e=$(".navbar").height(),Fe=Me.height(),He=[],Be=[],Ae=[],Ue={},qe={},Ke={},Qe={},Xe={},en=!1,nn=!1,tn=Publish.interval||1e3,on={Point:"Point",MultiPoint:"MultiPoint",LineString:"LineString",MultiLineString:"MultiLineString",WMS:"WMS"};google.maps.event.addDomListener(window,"load",N),we.on("click",function(){$(this).closest(".sidebar-body").fadeOut("slide",function(){$e.fadeIn(),Q()})}),$e.on("click",function(){var e=$(this);ye.toggle("slide"),e.hide(),Q()}),Se.on("click",function(){xe.modal("show")}),Ye.on("click",function(){Ze.modal("show")}),$(window).on("resize",Q),Pe.modal("show"),function(){if(X()&&(ye.fadeOut("slide"),$e.fadeIn()),$("#logo")){var e=_e-50;$("body").css("padding-top",e),$e.css("margin-top",e)}var n=Publish.fontSize;if(n){var t=$(".custom-font-layer"),i=$(".custom-font-app-title"),o=$(".custom-font-group-title"),r=$(".custom-font-report-title"),a=$(".custom-font-subtitle"),l=$(".custom-font-body"),s=$(".custom-font-legend"),c=$(".custom-font-more "),u=function(e){return parseFloat(e.css("font-size"))},d=function(e,n){e.css("font-size",n+"px")},p=u(t),f=function(e){var t=u(e)-p;d(e,n+t)};d(t,n),f(i),f(o),f(r),f(a),f(l),f(s),f(c)}}(),Q()});