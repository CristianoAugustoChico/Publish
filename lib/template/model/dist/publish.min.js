$(function(){function e(e,t,n){var o=$('<div style="height:25px;">');t.endsWith(".png")?o.append($('<div class="legend-img-box">').css("background-image","url("+t+")")):o.append($('<div class="legend-color-box">').css({backgroundColor:t})),o.append($("<span>").css("lineHeight","23px").html(n)),e.append(o)}function t(t){q.empty(),ie.text(" "+Publish.legend);var n=[];$.each(t,function(e){n.push(e)}),n.sort(),$.each(n,function(n,o){var i=t[o];e(q,i,o)})}function n(e,n){var o=e.label,i=n||"Description",a=e.description.split("."),r=a[0]?a[0]+".":"",s=Ce+40,l=40*(xe-s)/100,c=20*(xe-s)/100;ve.height()<l&&(c=30*(xe-s)/100),ve.css("max-height",l),te.css("max-height",c),ne.css("max-height",c),a.length-1>1?me.show():me.hide(),oe.text(" "+i),ee.text(r||""),fe.text(" "+i),he.text(e.description||""),t(o)}function o(e){return{fillColor:e.getProperty("color"),strokeColor:e.getProperty("border"),strokeWeight:e.getProperty("width"),zIndex:e.getProperty("order"),icon:e.getProperty("icon")}}function i(e){var t=e.color;if(e.slices){var n=Object.keys(t).sort(function(e,t){return e-t}),o=n.map(Number);return function(e){var i=null;return $.each(o,function(o,a){e>=a&&(i=t[n[o]])}),i}}return function(e){return t[e]}}function a(e,t,n){var o=n.geom||e.getGeometry().getType(),a=H(n,1),r=i(n);if(!n.icon||o!==Te.Point&&o!==Te.MultiPoint){var s=a||t,l=n.color;"object"===$.type(l)?e.setProperty("color",r(e.getProperty(s))):e.setProperty("color",l),e.setProperty("border",n.border),e.setProperty("width",n.width)}else{var c=n.icon.options[e.getProperty(a)];c||(c=n.icon.path),e.setProperty("icon",c)}e.setProperty("order",n.order)}function r(e,t,n){e.setStyle(o),n.report&&e.addListener("click",function(e){if("function"===n.report){var o=e.feature.getProperty(H(n,0));"string"===$.type(o)&&(o=o.replace(/\s/g,"")),$("#modal-report-"+t+o).modal("show")}else $("#modal-report-"+t).modal("show")}),U[t]=e}function s(e,t,n){$.each(t,function(t,o){o.getVisible()?P(e,o):(w(e,o,n),m(e,te.hasClass("in"),ne.hasClass("in")))})}function l(e){return e.geom===Te.LineString}function c(e){return e.geom===Te.MultiLineString}function u(e){return l(e)||c(e)}function p(e,t,n){var o=t.time?t.id:e;if("WMS"===t.geom){var i=new $.Deferred,a=new geoambiente.maps.WmsLayer({url:t.url,layer:t.name,visibility:t.visible,opacity:t.transparency,map:A});return i.resolve(a),U[e]=a,t.visible&&F(o,!0),n&&n(a),i.promise()}var r=Publish.path+e+".geojson";return $.getJSON(r,function(i){var a=new google.maps.Data;a.addGeoJson(i),u(t)?M(a,e,t):(C(a,e,t),t.visible&&(a.setMap(A),F(o,!0)),n&&n(a))})}function d(e,t){e.setMap(null),F(t,!1)}function f(e,t){e.setMap(A),F(t,!0),m(t,te.hasClass("in"),ne.hasClass("in"))}function h(e,t,n){if(t=t||Publish.data[e],t.time&&!n)$.each(t.name,function(e,n){h(n,t,!0)});else{var o=U[e];if(o)if(u(t)){var i=t.icon.time;l(t)?s(e,o,i):$.each(o,function(t,n){s(e,n,i)})}else{var a=t.time?t.id:e;t.geom===Te.WMS?o.getVisibility()?d(o,a):f(o,a):o.getMap()?d(o,a):f(o,a)}else O(),X.empty(),k(e,1,1),p(e,t).done(function(){m(e,te.hasClass("in"),ne.hasClass("in"))}).always(function(){z()})}}function g(e,t){B=null,q.empty(),ee.empty(),oe.text(" Description"),re.hide(),$("button").removeClass("button-selected"),e&&(oe.click(),oe.prop("disabled",!0)),t&&(ie.click(),ie.prop("disabled",!0))}function m(e,t,o){B=e;var i=Publish.data[e];if(n(i,Y[e]),t||(oe.prop("disabled",!1),oe.click()),o||(ie.prop("disabled",!1),ie.click()),i.download){var a=e+".zip";ae.prop("href",Publish.path+a),ae.prop("download",a),re.show()}else re.hide();$("button").removeClass("button-selected"),$("#"+e).addClass("button-selected")}function v(e){var t=e.target.id;if(t){var n=te.hasClass("in"),o=ne.hasClass("in");B===t?g(n,o):m(t,n,o)}else{if(!(t=e.target.name))return;var i=Publish.group;if(i){var a=Publish.data[t].group,r=i[a];r?(h(r),r===t?i[a]=null:(i[a]=t,h(t))):(i[a]=t,h(t))}else h(t);if(Se){var s=E();s&&null!==Pe?(Pe.appendTo(we),Pe=null):s||null!==Pe||(Pe=ye.detach())}}}function b(e,t,n){var o=0,i=setInterval(function(){o=(o+1)%200;var e=t.get("icons");e[0].offset=o/2+"%",t.set("icons",e)},n);window.intervals||(window.intervals={}),window.intervals[e]||(window.intervals[e]=[]),window.intervals[e].push(i)}function y(e,t){var n=e.icon.options,o=[];t.forEachLatLng(function(e){o.push(e)});var i={path:n.path,anchor:new google.maps.Point(175,175),scale:.1,fillColor:n.fillColor,fillOpacity:n.fillOpacity,strokeWeight:n.strokeWeight},a={path:o,icons:[{icon:i}],strokeWeight:e.width,strokeColor:e.border||e.color,strokeOpacity:e.transparency};return new google.maps.Polyline(a)}function w(e,t,n){t.setMap(A),t.setVisible(!0),b(e,t,n)}function P(e,t){t.setMap(null),t.setVisible(!1),window.intervals&&$.each(window.intervals[e],function(e,t){clearInterval(t)})}function M(e,t,n){var o=[],i=n.visible,a=n.icon.time;e.forEach(function(e){var r=e.getGeometry();if(l(n)){var s=y(n,r);o.push(s),i&&w(t,s,a)}else if(c(n)){var u=[];$.each(r.getArray(),function(e,o){var r=y(n,o);u.push(r),i&&w(t,r,a)}),o.push(u)}}),U[t]=o,i&&F(t,!0)}function C(e,t,n){e.forEach(function(e){a(e,t,n)}),r(e,t,n)}function x(e,t,n){return"Loading"+Y[e]+" ("+t+"/"+n+")"}function k(e,t,n){var o=x(e,t,n);X.text(o)}function O(){K.fadeIn(),Q.css("z-index",1e7)}function z(){K.fadeOut(),X.empty(),Q.css("z-index",-1)}function L(e,t){function n(e,t,n){return Math.floor(Math.log(e/t/n)/Math.LN2)}if("number"===$.type(e))return e;var o=n(xe,e.yTile,e.latFraction),i=n(ge.width(),e.xTile,e.longFraction);return Math.min(o,i,t)}function S(e){var t=[],n=0,o=Object.keys(e).length,i=!1;O(),$.each(e,function(e,s){_(s);var l=s.visible,c=s.time;if(!l&&!c)return!0;if(n+=1,X.empty(),k(e,n,o),c){var u=0;if("creation"===c){var d=Publish.path+e+".geojson";t.push($.getJSON(d,function(t){var n=new google.maps.Data;n.addGeoJson(t);var o={};$.each(s.timeline,function(e,t){o[t]=new google.maps.Data});var i=s.name;n.forEach(function(t){a(t,e,s);var n=t.getProperty(i),r=o[n];r&&r.add(t)}),s.name=[],$.each(o,function(t,n){var o=e+"_"+t;r(n,o,s),G(t,n,e,c),s.name.push(o),u++,l&&(n.setMap(A),F(e,!0))})}))}else $.each(s.name,function(n,o){var i=s.timeline[u];t.push(p(o,s,function(t){G(i,t,e,c)})),u++});!Se&&l&&(Se=!0,i=!0)}else t.push(p(e,s))});var s=te.hasClass("in"),l=ne.hasClass("in");m(ve.find(":button")[0].id,s,l),$.when.apply($,t).always(function(){i&&Se&&I(),z()})}function T(){google.maps.visualRefresh=!0;var e={center:new google.maps.LatLng(Publish.center.lat,Publish.center.long),zoom:L(Publish.zoom,Publish.maxZoom),minZoom:Publish.minZoom,maxZoom:Publish.maxZoom,mapTypeId:google.maps.MapTypeId[Publish.mapTypeId],mapTypeControl:!0,mapTypeControlOptions:{style:google.maps.MapTypeControlStyle.DROPDOWN_MENU,position:google.maps.ControlPosition.TOP_RIGHT}};A=new google.maps.Map(ge[0],e),A.controls[google.maps.ControlPosition.BOTTOM_RIGHT].push($("#footer")[0]),J(),google.maps.event.addListenerOnce(A,"idle",function(){S(Publish.data)})}function I(){$e.slider({range:!0,min:0,max:Oe.length-1,step:1,values:[0,Oe.length-1]}).each(D).on("slide",W)}function W(e,t){var n=Oe.length-1;Me.css("left",t.values[1]/n*100+"%"),ze=t.values,$.each(ke,function(e,n){Le[n.type]&&n.year===Oe[t.values[1]]?n.layer.setMap(A):n.layer.setMap(null)})}function D(){var e=Oe.length-1,t=0;ze=[0,Oe.length-1],$.each(Oe,function(n,o){var i=$("<label>"+o+"</label>").css("left",t/e*100+"%");$e.append(i),t++})}function G(e,t,n,o){var i=Z(e),a=j(e);i?N(n,t,e,o):(Oe.splice(a,0,e),N(n,t,e,o))}function N(e,t,n,o){ke.push({type:e,layer:t,year:n,time:o})}function j(e){var t=0;return $.each(Oe,function(n,o){return o===e?n:e<o?n:void t++}),t}function E(){var e=!1;return Se&&ke.length>0&&$.each(ke,function(t,n){if(Le[n.type])return e=!0,!1}),e}function Z(e){var t=!1;return $.each(Oe,function(n,o){o===e&&(t=!0)}),t}function J(){var e=ve.find(":button");e.each(function(e,t){Y[t.id]=t.innerText,Le[t.id]=!1}),e.click(v),oe.prop("disabled",!0),ie.prop("disabled",!0),re.hide()}function R(){if(se.is(":visible"))ge.find(".ol-zoom").css("margin-left",0).removeClass("zoom-top-opened-sidebar").addClass("zoom-top-collapsed");else{var e=$(".sidebar-left");ge.find(".ol-zoom").css("margin-left",e.width()).removeClass("zoom-top-opened-sidebar").removeClass("zoom-top-collapsed")}}function V(){return le.width()===$(window).width()}function _(e){if(!e.label){e.label={};e.label[e.id]=e.color||e.border||"rgba(0, 0, 0, 1)"}}function F(e,t){Le[e]!==t&&(Le[e]=t,$("#"+e).children("input").prop("checked",t))}function H(e,t){return"array"===$.type(e.select)?e.select[t]:e.select}var A,B,U={},Y={},q=$("#legend"),K=$("#loader"),Q=$("#loader-message"),X=$("#loader-message-text"),ee=$("#layer-description"),te=$("#properties"),ne=$("#legends"),oe=$("#description-title"),ie=$("#legend-title"),ae=$("#download-title"),re=$("#panel-download"),se=$(".mini-submenu-left"),le=$(".sidebar"),ce=$(".sidebar-left .sidebar-body"),ue=$(".sidebar-left .slide-submenu"),pe=$("#modal-app-description"),de=$("#modal-completed-description"),fe=$("#modal-title-description"),he=$("#info-description"),ge=$("#map"),me=$("#more"),ve=$("#layers"),be=$("#play"),$e=$("#slider"),ye=$("#slider-container"),we=$("#slider-col"),Pe=null,Me=$("#spanSelectedYear"),Ce=$(".navbar").height(),xe=ge.height(),ke=[],Oe=[],ze=[],Le={},Se=!1,Te={Point:"Point",MultiPoint:"MultiPoint",LineString:"LineString",MultiLineString:"MultiLineString",WMS:"WMS"};google.maps.event.addDomListener(window,"load",T),be.on("click",function(){be.prop("disabled",!0),$e.slider("disable");var e=Oe.length-1,t=ze[0],n=null;n=setInterval(function(){t<=ze[1]?(Me.css("left",t/e*100+"%"),$.each(ke,function(e,n){n.year===Oe[t]?n.layer.setMap(A):n.layer.setMap(null)}),t++):(clearInterval(n),be.prop("disabled",!1),$e.slider("enable"))},1e3)}),ue.on("click",function(){$(this).closest(".sidebar-body").fadeOut("slide",function(){se.fadeIn(),R()})}),se.on("click",function(){var e=$(this);ce.toggle("slide"),e.hide(),R()}),me.on("click",function(){de.modal("show")}),$(window).on("resize",R),pe.modal("show"),function(){if(V()&&(ce.fadeOut("slide"),se.fadeIn()),$("#logo")){var e=Ce-50;$("body").css("padding-top",e),se.css("margin-top",e)}var t=Publish.fontSize;if(t){var n=$(".custom-font-layer"),o=$(".custom-font-app-title"),i=$(".custom-font-group-title"),a=$(".custom-font-report-title"),r=$(".custom-font-subtitle"),s=$(".custom-font-body"),l=$(".custom-font-legend"),c=$(".custom-font-more "),u=function(e){return parseFloat(e.css("font-size"))},p=function(e,t){e.css("font-size",t+"px")},d=u(n),f=function(e){var n=u(e)-d;p(e,t+n)};p(n,t),f(o),f(i),f(a),f(r),f(s),f(l),f(c)}}(),R()});