$(function(){function e(e,t,o){var n=$('<div style="height:25px;">');t.endsWith(".png")?n.append($('<div class="legend-img-box">').css("background-image","url("+t+")")):n.append($('<div class="legend-color-box">').css({backgroundColor:t})),n.append($("<span>").css("lineHeight","23px").html(o)),e.append(n)}function t(t){F.empty(),K.text(" "+Publish.legend);var o=[];$.each(t,function(e){o.push(e)}),o.sort(),$.each(o,function(o,n){var i=t[n];e(F,i,n)})}function o(e,o){var n=e.label,i=o||"Description",r=e.description.split("."),s=r[0]?r[0]+".":"",a=de+40,l=40*(ue-a)/100,c=20*(ue-a)/100;ce.height()<l&&(c=30*(ue-a)/100),ce.css("max-height",l),B.css("max-height",c),U.css("max-height",c),r.length-1>1?le.show():le.hide(),q.text(" "+i),A.text(s||""),re.text(" "+i),se.text(e.description||""),t(n)}function n(e){return{fillColor:e.getProperty("color"),strokeColor:e.getProperty("border"),strokeWeight:e.getProperty("width"),zIndex:e.getProperty("order"),icon:e.getProperty("icon")}}function i(e){var t=e.color;if(e.slices){var o=Object.keys(t).sort(function(e,t){return e-t}),n=o.map(Number);return function(e){var i=null;return $.each(n,function(n,r){e>=r&&(i=t[o[n]])}),i}}return function(e){return t[e]}}function r(e,t){var o=t.geom||e.getGeometry().getType(),n=Z(t,1),r=i(t);if(!t.icon||o!==pe.Point&&o!==pe.MultiPoint){var s=n||t.id,a=t.color;"object"===$.type(a)?e.setProperty("color",r(e.getProperty(s))):e.setProperty("color",a),e.setProperty("border",t.border),e.setProperty("width",t.width)}else{var l=t.icon.options[e.getProperty(n)];l||(l=t.icon.path),e.setProperty("icon",l)}e.setProperty("order",t.order)}function s(e,t){var o=t.id;e.setStyle(n),t.report&&e.addListener("click",function(e){if("function"===t.report){var n=e.feature.getProperty(Z(t,0));"string"===$.type(n)&&(n=n.replace(/\s/g,"")),$("#modal-report-"+o+n).modal("show")}else $("#modal-report-"+o).modal("show")}),R[o]=e}function a(e,t,o){$.each(t,function(t,n){n.getVisible()?P(e,n):(w(e,n,o),m(e,B.hasClass("in"),U.hasClass("in")))})}function l(e){return e.geom===pe.LineString}function c(e){return e.geom===pe.MultiLineString}function d(e){return l(e)||c(e)}function u(e,t){if("WMS"===t.geom){var o=new $.Deferred,n=new geoambiente.maps.WmsLayer({url:t.url,layer:t.name,visibility:t.visible,opacity:t.transparency,map:j});return o.resolve(n),R[e]=n,N(e,!0),o.promise()}var i=Publish.path+e+".geojson";return $.getJSON(i,function(o){var n=new google.maps.Data;n.addGeoJson(o),d(t)?C(n,t):(M(n,t),n.setMap(j),N(e,!0))})}function p(e,t){e.setMap(null),N(t,!1)}function f(e,t){e.setMap(j),N(t,!0),m(t,B.hasClass("in"),U.hasClass("in"))}function h(e){var t=R[e],o=Publish.data[e];if(t)if(d(o)){var n=o.icon.time;l(o)?a(o.id,t,n):$.each(t,function(e,t){a(o.id,t,n)})}else o.geom===pe.WMS?t.getVisibility()?p(t,e):f(t,e):t.getMap()?p(t,e):f(t,e);else z(),J.empty(),k(e,1,1),u(e,o).done(function(){m(e,B.hasClass("in"),U.hasClass("in"))}).always(function(){L()})}function g(e,t){E=null,F.empty(),A.empty(),q.text(" Description"),X.hide(),$("button").removeClass("button-selected"),e&&(q.click(),q.prop("disabled",!0)),t&&(K.click(),K.prop("disabled",!0))}function m(e,t,n){E=e;var i=Publish.data[e];if(o(i,V[e]),t||(q.prop("disabled",!1),q.click()),n||(K.prop("disabled",!1),K.click()),i.download){var r=e+".zip";Q.prop("href",Publish.path+r),Q.prop("download",r),X.show()}else X.hide();$("button").removeClass("button-selected"),$("#"+e).addClass("button-selected")}function b(e){var t=e.target.id;if(t){var o=B.hasClass("in"),n=U.hasClass("in");E===t?g(o,n):m(t,o,n)}else{if(!(t=e.target.name))return;var i=Publish.group;if(i){var r=Publish.data[t].group,s=i[r];s?(h(s),s===t?i[r]=null:(i[r]=t,h(t))):(i[r]=t,h(t))}else h(t)}}function v(e,t,o){var n=0,i=setInterval(function(){n=(n+1)%200;var e=t.get("icons");e[0].offset=n/2+"%",t.set("icons",e)},o);window.intervals||(window.intervals={}),window.intervals[e]||(window.intervals[e]=[]),window.intervals[e].push(i)}function y(e,t){var o=e.icon.options,n=[];t.forEachLatLng(function(e){n.push(e)});var i={path:o.path,anchor:new google.maps.Point(175,175),scale:.1,fillColor:o.fillColor,fillOpacity:o.fillOpacity,strokeWeight:o.strokeWeight},r={path:n,icons:[{icon:i}],strokeWeight:e.width,strokeColor:e.border||e.color,strokeOpacity:e.transparency};return new google.maps.Polyline(r)}function w(e,t,o){t.setMap(j),t.setVisible(!0),v(e,t,o)}function P(e,t){t.setMap(null),t.setVisible(!1),window.intervals&&$.each(window.intervals[e],function(e,t){clearInterval(t)})}function C(e,t){var o=[],n=t.visible,i=t.icon.time;e.forEach(function(e){var r=e.getGeometry();if(l(t)){var s=y(t,r);o.push(s),n&&w(t.id,s,i)}else if(c(t)){var a=[];$.each(r.getArray(),function(e,o){var r=y(t,o);a.push(r),n&&w(t.id,r,i)}),o.push(a)}}),R[t.id]=o,n&&N(t.id,!0)}function M(e,t){e.forEach(function(e){r(e,t)}),s(e,t)}function x(e,t,o){return"Loading"+V[e]+" ("+t+"/"+o+")"}function k(e,t,o){var n=x(e,t,o);J.text(n)}function z(){H.fadeIn(),_.css("z-index",1e7)}function L(){H.fadeOut(),J.empty(),_.css("z-index",-1)}function O(e,t){function o(e,t,o){return Math.floor(Math.log(e/t/o)/Math.LN2)}if("number"===$.type(e))return e;var n=o(ue,e.yTile,e.latFraction),i=o(ae.width(),e.xTile,e.longFraction);return Math.min(n,i,t)}function T(e){var t=[],o=0,n=Object.keys(e).length;z(),$.each(e,function(e,i){if(G(i),!i.visible)return!0;o+=1,J.empty(),k(e,o,n),t.push(u(e,i))});var i=B.hasClass("in"),r=U.hasClass("in");m(ce.find(":button")[0].id,i,r),$.when.apply($,t).always(function(){L()})}function S(){google.maps.visualRefresh=!0;var e={center:new google.maps.LatLng(Publish.center.lat,Publish.center.long),zoom:O(Publish.zoom,Publish.maxZoom),minZoom:Publish.minZoom,maxZoom:Publish.maxZoom,mapTypeId:google.maps.MapTypeId[Publish.mapTypeId],mapTypeControl:!0,mapTypeControlOptions:{style:google.maps.MapTypeControlStyle.DROPDOWN_MENU,position:google.maps.ControlPosition.TOP_RIGHT}};j=new google.maps.Map(ae[0],e),j.controls[google.maps.ControlPosition.BOTTOM_RIGHT].push($("#footer")[0]),I(),google.maps.event.addListenerOnce(j,"idle",function(){T(Publish.data)})}function I(){var e=ce.find(":button");e.each(function(e,t){V[t.id]=t.innerText}),e.click(b),q.prop("disabled",!0),K.prop("disabled",!0),X.hide()}function W(){if(Y.is(":visible"))ae.find(".ol-zoom").css("margin-left",0).removeClass("zoom-top-opened-sidebar").addClass("zoom-top-collapsed");else{var e=$(".sidebar-left");ae.find(".ol-zoom").css("margin-left",e.width()).removeClass("zoom-top-opened-sidebar").removeClass("zoom-top-collapsed")}}function D(){return ee.width()===$(window).width()}function G(e){if(!e.label){e.label={};e.label[e.id]=e.color||e.border||"rgba(0, 0, 0, 1)"}}function N(e,t){$("#"+e).children("input").prop("checked",t)}function Z(e,t){return"array"===$.type(e.select)?e.select[t]:e.select}var j,E,R={},V={},F=$("#legend"),H=$("#loader"),_=$("#loader-message"),J=$("#loader-message-text"),A=$("#layer-description"),B=$("#properties"),U=$("#legends"),q=$("#description-title"),K=$("#legend-title"),Q=$("#download-title"),X=$("#panel-download"),Y=$(".mini-submenu-left"),ee=$(".sidebar"),te=$(".sidebar-left .sidebar-body"),oe=$(".sidebar-left .slide-submenu"),ne=$("#modal-app-description"),ie=$("#modal-completed-description"),re=$("#modal-title-description"),se=$("#info-description"),ae=$("#map"),le=$("#more"),ce=$("#layers"),de=$(".navbar").height(),ue=ae.height(),pe={Point:"Point",MultiPoint:"MultiPoint",LineString:"LineString",MultiLineString:"MultiLineString",WMS:"WMS"};google.maps.event.addDomListener(window,"load",S),oe.on("click",function(){$(this).closest(".sidebar-body").fadeOut("slide",function(){Y.fadeIn(),W()})}),Y.on("click",function(){var e=$(this);te.toggle("slide"),e.hide(),W()}),le.on("click",function(){ie.modal("show")}),$(window).on("resize",W),ne.modal("show"),function(){if(D()&&(te.fadeOut("slide"),Y.fadeIn()),$("#logo")){var e=de-50;$("body").css("padding-top",e),Y.css("margin-top",e)}var t=Publish.fontSize;if(t){var o=$(".custom-font-layer"),n=$(".custom-font-app-title"),i=$(".custom-font-group-title"),r=$(".custom-font-report-title"),s=$(".custom-font-subtitle"),a=$(".custom-font-body"),l=$(".custom-font-legend"),c=$(".custom-font-more "),d=function(e){return parseFloat(e.css("font-size"))},u=function(e,t){e.css("font-size",t+"px")},p=d(o),f=function(e){var o=d(e)-p;u(e,t+o)};u(o,t),f(n),f(i),f(r),f(s),f(a),f(l),f(c)}}(),W()});