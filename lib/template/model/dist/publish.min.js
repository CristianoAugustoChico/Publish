$(function(){function e(e,t,n){var o=$('<div style="height:25px;">');t.endsWith(".png")?o.append($('<div class="legend-img-box">').css("background-image","url("+t+")")):o.append($('<div class="legend-color-box">').css({backgroundColor:t})),o.append($("<span>").css("lineHeight","23px").html(n)),e.append(o)}function t(t){U.empty(),ne.text(" "+Publish.legend);var n=[];$.each(t,function(e){n.push(e)}),n.sort(),$.each(n,function(n,o){var i=t[o];e(U,i,o)})}function n(e,n){var o=e.label,i=n||"Description",a=e.description.split("."),r=a[0]?a[0]+".":"",s=Pe+40,l=40*(Me-s)/100,c=20*(Me-s)/100;me.height()<l&&(c=30*(Me-s)/100),me.css("max-height",l),X.css("max-height",c),ee.css("max-height",c),a.length-1>1?he.show():he.hide(),te.text(" "+i),Q.text(r||""),pe.text(" "+i),de.text(e.description||""),t(o)}function o(e){return{fillColor:e.getProperty("color"),strokeColor:e.getProperty("border"),strokeWeight:e.getProperty("width"),zIndex:e.getProperty("order"),icon:e.getProperty("icon")}}function i(e){var t=e.color;if(e.slices){var n=Object.keys(t).sort(function(e,t){return e-t}),o=n.map(Number);return function(e){var i=null;return $.each(o,function(o,a){e>=a&&(i=t[n[o]])}),i}}return function(e){return t[e]}}function a(e,t,n){var o=n.geom||e.getGeometry().getType(),a=_(n,1),r=i(n);if(!n.icon||o!==Oe.Point&&o!==Oe.MultiPoint){var s=a||t,l=n.color;"object"===$.type(l)?e.setProperty("color",r(e.getProperty(s))):e.setProperty("color",l),e.setProperty("border",n.border),e.setProperty("width",n.width)}else{var c=n.icon.options[e.getProperty(a)];c||(c=n.icon.path),e.setProperty("icon",c)}e.setProperty("order",n.order)}function r(e,t,n){e.setStyle(o),n.report&&e.addListener("click",function(e){if("function"===n.report){var o=e.feature.getProperty(_(n,0));"string"===$.type(o)&&(o=o.replace(/\s/g,"")),$("#modal-report-"+t+o).modal("show")}else $("#modal-report-"+t).modal("show")}),A[t]=e}function s(e,t,n){$.each(t,function(t,o){o.getVisible()?P(e,o):(w(e,o,n),g(e,X.hasClass("in"),ee.hasClass("in")))})}function l(e){return e.geom===Oe.LineString}function c(e){return e.geom===Oe.MultiLineString}function u(e){return l(e)||c(e)}function p(e,t,n){var o=t.time?t.id:e;if("WMS"===t.geom){var i=new $.Deferred,a=new geoambiente.maps.WmsLayer({url:t.url,layer:t.name,visibility:t.visible,opacity:t.transparency,map:F});return i.resolve(a),A[e]=a,t.visible&&V(o,!0),n&&n(a),i.promise()}var r=Publish.path+e+".geojson";return $.getJSON(r,function(i){var a=new google.maps.Data;a.addGeoJson(i),u(t)?M(a,e,t):(C(a,e,t),a.setMap(F),t.visible&&V(o,!0),n&&n(a))})}function d(e,t){e.setMap(null),V(t,!1),ye||(ye=$e.detach())}function f(e,t){e.setMap(F),V(t,!0),g(t,X.hasClass("in"),ee.hasClass("in")),ye&&ye.appendTo(be)}function h(e,t,n){if(t=t||Publish.data[e],t.time&&!n)$.each(t.name,function(e,n){h(n,t,!0)});else{var o=A[e];if(o)if(u(t)){var i=t.icon.time;l(t)?s(e,o,i):$.each(o,function(t,n){s(e,n,i)})}else{var a=t.time?t.id:e;t.geom===Oe.WMS?o.getVisibility()?d(o,a):f(o,a):o.getMap()?d(o,a):f(o,a)}else O(),K.empty(),k(e,1,1),p(e,t).done(function(){g(e,X.hasClass("in"),ee.hasClass("in"))}).always(function(){z()})}}function m(e,t){H=null,U.empty(),Q.empty(),te.text(" Description"),ie.hide(),$("button").removeClass("button-selected"),e&&(te.click(),te.prop("disabled",!0)),t&&(ne.click(),ne.prop("disabled",!0))}function g(e,t,o){H=e;var i=Publish.data[e];if(n(i,B[e]),t||(te.prop("disabled",!1),te.click()),o||(ne.prop("disabled",!1),ne.click()),i.download){var a=e+".zip";oe.prop("href",Publish.path+a),oe.prop("download",a),ie.show()}else ie.hide();$("button").removeClass("button-selected"),$("#"+e).addClass("button-selected")}function v(e){var t=e.target.id;if(t){var n=X.hasClass("in"),o=ee.hasClass("in");H===t?m(n,o):g(t,n,o)}else{if(!(t=e.target.name))return;var i=Publish.group;if(i){var a=Publish.data[t].group,r=i[a];r?(h(r),r===t?i[a]=null:(i[a]=t,h(t))):(i[a]=t,h(t))}else h(t)}}function b(e,t,n){var o=0,i=setInterval(function(){o=(o+1)%200;var e=t.get("icons");e[0].offset=o/2+"%",t.set("icons",e)},n);window.intervals||(window.intervals={}),window.intervals[e]||(window.intervals[e]=[]),window.intervals[e].push(i)}function y(e,t){var n=e.icon.options,o=[];t.forEachLatLng(function(e){o.push(e)});var i={path:n.path,anchor:new google.maps.Point(175,175),scale:.1,fillColor:n.fillColor,fillOpacity:n.fillOpacity,strokeWeight:n.strokeWeight},a={path:o,icons:[{icon:i}],strokeWeight:e.width,strokeColor:e.border||e.color,strokeOpacity:e.transparency};return new google.maps.Polyline(a)}function w(e,t,n){t.setMap(F),t.setVisible(!0),b(e,t,n)}function P(e,t){t.setMap(null),t.setVisible(!1),window.intervals&&$.each(window.intervals[e],function(e,t){clearInterval(t)})}function M(e,t,n){var o=[],i=n.visible,a=n.icon.time;e.forEach(function(e){var r=e.getGeometry();if(l(n)){var s=y(n,r);o.push(s),i&&w(t,s,a)}else if(c(n)){var u=[];$.each(r.getArray(),function(e,o){var r=y(n,o);u.push(r),i&&w(t,r,a)}),o.push(u)}}),A[t]=o,i&&V(t,!0)}function C(e,t,n){e.forEach(function(e){a(e,t,n)}),r(e,t,n)}function x(e,t,n){return"Loading"+B[e]+" ("+t+"/"+n+")"}function k(e,t,n){var o=x(e,t,n);K.text(o)}function O(){Y.fadeIn(),q.css("z-index",1e7)}function z(){Y.fadeOut(),K.empty(),q.css("z-index",-1)}function L(e,t){function n(e,t,n){return Math.floor(Math.log(e/t/n)/Math.LN2)}if("number"===$.type(e))return e;var o=n(Me,e.yTile,e.latFraction),i=n(fe.width(),e.xTile,e.longFraction);return Math.min(o,i,t)}function S(e){var t=[],n=0,o=Object.keys(e).length,i=!1;O(),$.each(e,function(e,s){if(R(s),!s.visible&&!s.time)return!0;n+=1,K.empty(),k(e,n,o);var l=s.time;if(l){var c=0;if("creation"===l){var u=Publish.path+e+".geojson";t.push($.getJSON(u,function(t){var n=new google.maps.Data;n.addGeoJson(t);var o={};$.each(s.timeline,function(e,t){o[t]=new google.maps.Data});var i=s.name;n.forEach(function(t){a(t,e,s);var n=t.getProperty(i),r=o[n];r&&r.add(t)}),s.name=[],$.each(o,function(t,n){var o=e+"_"+t;r(n,o,s),D(t,n,e,l),s.name.push(o),c++}),s.visible&&V(e,!0)}))}else $.each(s.name,function(n,o){var i=s.timeline[c];t.push(p(o,s,function(t){D(i,t,e,l)})),c++});!i&&s.visible&&(i=!0)}else t.push(p(e,s))});var s=X.hasClass("in"),l=ee.hasClass("in");g(me.find(":button")[0].id,s,l),$.when.apply($,t).always(function(){i&&ve.slider({range:!0,min:0,max:xe.length-1,step:1,values:[0,xe.length-1]}).each(W).on("slide",I),z()})}function T(){google.maps.visualRefresh=!0;var e={center:new google.maps.LatLng(Publish.center.lat,Publish.center.long),zoom:L(Publish.zoom,Publish.maxZoom),minZoom:Publish.minZoom,maxZoom:Publish.maxZoom,mapTypeId:google.maps.MapTypeId[Publish.mapTypeId],mapTypeControl:!0,mapTypeControlOptions:{style:google.maps.MapTypeControlStyle.DROPDOWN_MENU,position:google.maps.ControlPosition.TOP_RIGHT}};F=new google.maps.Map(fe[0],e),F.controls[google.maps.ControlPosition.BOTTOM_RIGHT].push($("#footer")[0]),E(),google.maps.event.addListenerOnce(F,"idle",function(){S(Publish.data)})}function I(e,t){var n=xe.length-1;we.css("left",t.values[1]/n*100+"%"),ke=t.values,$.each(Ce,function(e,n){n.year===xe[t.values[1]]?n.layer.setMap(F):n.layer.setMap(null)})}function W(){var e=xe.length-1,t=0;ke=[0,xe.length-1],$.each(xe,function(n,o){var i=$("<label>"+o+"</label>").css("left",t/e*100+"%");ve.append(i),t++})}function D(e,t,n,o){var i=j(e),a=N(e);i?G(n,t,e,o):(xe.splice(a,0,e),G(n,t,e,o))}function G(e,t,n,o){Ce.push({type:e,layer:t,year:n,time:o})}function N(e){var t=0;return $.each(xe,function(n,o){return o===e?n:e<o?n:void t++}),t}function j(e){var t=!1;return $.each(xe,function(n,o){o===e&&(t=!0)}),t}function E(){var e=me.find(":button");e.each(function(e,t){B[t.id]=t.innerText}),e.click(v),te.prop("disabled",!0),ne.prop("disabled",!0),ie.hide()}function Z(){if(ae.is(":visible"))fe.find(".ol-zoom").css("margin-left",0).removeClass("zoom-top-opened-sidebar").addClass("zoom-top-collapsed");else{var e=$(".sidebar-left");fe.find(".ol-zoom").css("margin-left",e.width()).removeClass("zoom-top-opened-sidebar").removeClass("zoom-top-collapsed")}}function J(){return re.width()===$(window).width()}function R(e){if(!e.label){e.label={};e.label[e.id]=e.color||e.border||"rgba(0, 0, 0, 1)"}}function V(e,t){$("#"+e).children("input").prop("checked",t)}function _(e,t){return"array"===$.type(e.select)?e.select[t]:e.select}var F,H,A={},B={},U=$("#legend"),Y=$("#loader"),q=$("#loader-message"),K=$("#loader-message-text"),Q=$("#layer-description"),X=$("#properties"),ee=$("#legends"),te=$("#description-title"),ne=$("#legend-title"),oe=$("#download-title"),ie=$("#panel-download"),ae=$(".mini-submenu-left"),re=$(".sidebar"),se=$(".sidebar-left .sidebar-body"),le=$(".sidebar-left .slide-submenu"),ce=$("#modal-app-description"),ue=$("#modal-completed-description"),pe=$("#modal-title-description"),de=$("#info-description"),fe=$("#map"),he=$("#more"),me=$("#layers"),ge=$("#play"),ve=$("#slider"),$e=$("#slider-container"),be=$("#slider-col"),ye=null,we=$("#spanSelectedYear"),Pe=$(".navbar").height(),Me=fe.height(),Ce=[],xe=[],ke=[],Oe={Point:"Point",MultiPoint:"MultiPoint",LineString:"LineString",MultiLineString:"MultiLineString",WMS:"WMS"};google.maps.event.addDomListener(window,"load",T),ge.on("click",function(){var e=xe.length-1,t=ke[0],n=null;n=setInterval(function(){t<=ke[1]?(we.css("left",t/e*100+"%"),$.each(Ce,function(e,n){n.year===xe[t]?n.layer.setMap(F):n.layer.setMap(null)}),t++):clearInterval(n)},1e3)}),le.on("click",function(){$(this).closest(".sidebar-body").fadeOut("slide",function(){ae.fadeIn(),Z()})}),ae.on("click",function(){var e=$(this);se.toggle("slide"),e.hide(),Z()}),he.on("click",function(){ue.modal("show")}),$(window).on("resize",Z),ce.modal("show"),function(){if(J()&&(se.fadeOut("slide"),ae.fadeIn()),$("#logo")){var e=Pe-50;$("body").css("padding-top",e),ae.css("margin-top",e)}var t=Publish.fontSize;if(t){var n=$(".custom-font-layer"),o=$(".custom-font-app-title"),i=$(".custom-font-group-title"),a=$(".custom-font-report-title"),r=$(".custom-font-subtitle"),s=$(".custom-font-body"),l=$(".custom-font-legend"),c=$(".custom-font-more "),u=function(e){return parseFloat(e.css("font-size"))},p=function(e,t){e.css("font-size",t+"px")},d=u(n),f=function(e){var n=u(e)-d;p(e,t+n)};p(n,t),f(o),f(i),f(a),f(r),f(s),f(l),f(c)}}(),Z()});