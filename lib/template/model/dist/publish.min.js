$(function(){function e(e,o,t){var i=$('<div style="height:25px;">').append($('<div class="legend-color-box">').css({backgroundColor:o})).append($("<span>").css("lineHeight","23px").html(t));e.append(i)}function o(o){S.empty(),W.text(" "+Publish.legend);var t=[];$.each(o,function(e){t.push(e)}),t.sort(),$.each(t,function(t,i){var n=o[i];e(S,n,i)})}function t(e,t){var i=e.label,n=t||"Description";E.text(" "+n),x.text(e.description||""),o(i)}function i(e){return{fillColor:e.getProperty("color"),strokeColor:e.getProperty("border"),strokeWeight:e.getProperty("width"),zIndex:e.getProperty("order"),icon:e.getProperty("icon")}}function n(e,o,t){t=t||e.getGeometry();var i=o.geom||t.getType();if(!o.icon||"Point"!==i&&"MultiPoint"!==i){var n=o.select||o.id,a=o.color;"object"==$.type(a)?e.setProperty("color",a[e.getProperty(n)]):e.setProperty("color",a),e.setProperty("border",o.border),e.setProperty("width",o.width)}else{var r=e.getProperty(o.icon.property);r=r?"./assets/"+r+".png":o.icon.path,e.setProperty("icon",r)}return e.setProperty("order",o.order),t}function a(e,o){var t=o.id;e.setStyle(i),e.addListener("click",function(e){if(!o.geom||"Point"!==o.geom&&"MultiPoint"!==o.geom)$("#modal-report-"+t).modal("show");else{var i=e.feature.getProperty(o.select);"string"==$.type(i)&&(i=i.replace(/\s/g,"-")),$("#modal-report-"+t+i).modal("show")}}),z[t]=e}function r(e,o,t){$.each(o,function(o,i){i.getVisible()?f(e,i):(g(e,i,t),d(e,D.hasClass("in"),G.hasClass("in")))})}function s(e){var o=z[e],t=Publish.data[e];if(o)if("LineString"===t.geom||"MultiLineString"===t.geom){var i=t.icon.time;"LineString"===t.geom?r(t.id,o,i):$.each(o,function(e,o){r(t.id,o,i)})}else o.getMap()?(o.setMap(null),M(e,!1)):(o.setMap(k),M(e,!0),d(e,D.hasClass("in"),G.hasClass("in")));else{T.fadeIn();var n=Publish.path+e+".geojson";$.getJSON(n,function(i){o=new google.maps.Data,L(t),o.addGeoJson(i),"LineString"===t.geom||"MultiLineString"===t.geom?m(o,t):(h(o,t),o.setMap(k)),M(e,!0),d(e,D.hasClass("in"),G.hasClass("in"))}).always(function(){T.fadeOut()})}return e}function l(e,o){O=null,S.empty(),x.empty(),E.text(" Description"),J.hide(),e&&(E.click(),E.prop("disabled",!0)),o&&(W.click(),W.prop("disabled",!0))}function d(e,o,i){O=e;var n=Publish.data[e];if(t(n,I[e]),o||(E.prop("disabled",!1),E.click()),i||(W.prop("disabled",!1),W.click()),n.download){var a=e+".zip";B.prop("href",Publish.path+a),B.prop("download",a),J.show()}else J.hide()}function p(e){var o=e.target.id;if(o){var t=D.hasClass("in"),i=G.hasClass("in");O===o?l(t,i):d(o,t,i)}else e.target.name&&s(e.target.name)}function c(e,o,t){var i=0,n=setInterval(function(){i=(i+1)%200;var e=o.get("icons");e[0].offset=i/2+"%",o.set("icons",e)},t);window.intervals||(window.intervals={}),window.intervals[e]||(window.intervals[e]=[]),window.intervals[e].push(n)}function u(e,o){var t=e.icon.options,i=[];o.forEachLatLng(function(e){i.push(e)});var n={path:t.path,anchor:new google.maps.Point(175,175),scale:.1,fillColor:t.fillColor,fillOpacity:t.fillOpacity,strokeWeight:t.strokeWeight},a={path:i,icons:[{icon:n}],strokeWeight:e.width,strokeColor:e.border||e.color,strokeOpacity:e.transparency};return new google.maps.Polyline(a)}function g(e,o,t){o.setMap(k),o.setVisible(!0),c(e,o,t)}function f(e,o){o.setMap(null),o.setVisible(!1),window.intervals&&$.each(window.intervals[e],function(e,o){clearInterval(o)})}function m(e,o){var t=[],i=o.visible,n=o.icon.time;e.forEach(function(e){var a=e.getGeometry();if("LineString"==o.geom){var r=u(o,a);t.push(r),i&&g(o.id,r,n)}else if("MultiLineString"==o.geom){var s=[];$.each(a.getArray(),function(e,t){var a=u(o,t);s.push(a),i&&g(o.id,a,n)}),t.push(s)}}),z[o.id]=t,i&&M(o.id,!0)}function h(e,o,t){e.forEach(function(e){var i=e.getGeometry();n(e,o,i),t&&t(i)}),a(e,o)}function b(e){var o=[],t=new google.maps.LatLngBounds;T.fadeIn(),$.each(e,function(e,i){L(i);var n=Publish.path+e+".geojson";o.push($.getJSON(n,function(e){var o=new google.maps.Data;o.addGeoJson(e),"LineString"===i.geom||"MultiLineString"===i.geom?m(o,i):(h(o,i,function(e){e.forEachLatLng(function(e){t.extend(e)})}),i.visible&&(o.setMap(k),M(i.id,!0)))}))}),$.when.apply($,o).done(function(){k.fitBounds(t)}).always(function(){T.fadeOut()})}function v(){var e=$("#layers").find(":button");e.each(function(e,o){I[o.id]=o.innerText}),e.click(p),E.prop("disabled",!0),W.prop("disabled",!0),J.hide()}function y(){google.maps.visualRefresh=!0;var e={minZoom:Publish.minZoom,maxZoom:Publish.maxZoom,mapTypeId:google.maps.MapTypeId[Publish.mapTypeId],mapTypeControl:!0,mapTypeControlOptions:{style:google.maps.MapTypeControlStyle.DROPDOWN_MENU,position:google.maps.ControlPosition.TOP_RIGHT}};Publish.center&&(e.center=new google.maps.LatLng(Publish.center.lat,Publish.center.long)),Publish.zoom&&(e.zoom=Publish.zoom);var o=document.getElementById("map");k=new google.maps.Map(o,e),k.controls[google.maps.ControlPosition.BOTTOM_RIGHT].push($("#footer")[0]),Publish.zoom||google.maps.event.addListenerOnce(k,"idle",function(){b(Publish.data)}),v()}function w(){var e=$(".mini-submenu-left");e.is(":visible")?$("#map").find(".ol-zoom").css("margin-left",0).removeClass("zoom-top-opened-sidebar").addClass("zoom-top-collapsed"):$("#map").find(".ol-zoom").css("margin-left",$(".sidebar-left").width()).removeClass("zoom-top-opened-sidebar").removeClass("zoom-top-collapsed")}function P(){return $(".sidebar").width()==$(window).width()}function C(){P()&&($(".sidebar-left .sidebar-body").fadeOut("slide"),$(".mini-submenu-left").fadeIn())}function L(e){e.label||(e.label={},e.label[e.id]=e.color||e.border)}function M(e,o){$("#"+e).children("input").prop("checked",o)}var k,O,z={},I={},S=$("#legend"),T=$("#loader"),x=$("#layer-description"),D=$("#properties"),G=$("#legends"),E=$("#description-title"),W=$("#legend-title"),B=$("#download-title"),J=$("#panel-download");google.maps.event.addDomListener(window,"load",y),$(".sidebar-left .slide-submenu").on("click",function(){var e=$(this);e.closest(".sidebar-body").fadeOut("slide",function(){$(".mini-submenu-left").fadeIn(),w()})}),$(".mini-submenu-left").on("click",function(){var e=$(this);$(".sidebar-left .sidebar-body").toggle("slide"),e.hide(),w()}),$(window).on("resize",w),$("#modal-app-description").modal("show"),C(),w()});