$(function(){function e(e,n,t){var i=$('<div style="height:25px;">');n.endsWith(".png")?i.append($('<div class="legend-img-box">').css("background-image","url("+n+")")):i.append($('<div class="legend-color-box">').css({backgroundColor:n})),i.append($("<span>").css("lineHeight","23px").html(t)),e.append(i)}function n(n){ne.empty(),ce.text(" "+Publish.legend);var t=[];$.each(n,function(e){t.push(e)}),t.sort(),$.each(t,function(t,i){var o=n[i];e(ne,o,i)})}function t(e,t){var i=e.label,o=t||"Description",r=e.description||"",a=r.split("."),s=a[0]?a[0]+".":"",l=Ve+40,c=40*(Ge-l)/100,u=20*(Ge-l)/100;Pe.height()<c&&(u=30*(Ge-l)/100),Pe.css("max-height",c),ae.css("max-height",u),se.css("max-height",u),a.length-1>1?we.show():we.hide(),le.text(" "+o),re.text(s),$e.text(" "+o),be.text(r),n(i)}function i(e){return{fillColor:e.getProperty("color"),strokeColor:e.getProperty("border"),strokeWeight:e.getProperty("width"),zIndex:e.getProperty("order"),icon:e.getProperty("icon")}}function o(e){var n=e.color;if(e.slices){var t=Object.keys(n).sort(function(e,n){return e-n}),i=t.map(Number);return function(e){var o=null;return $.each(i,function(i,r){e>=r&&(o=n[t[i]])}),o}}return function(e){return n[e]}}function r(e,n,t){var i=t.geom||e.getGeometry().getType(),r=q(t,1),a=o(t);if(!t.icon||i!==_e.Point&&i!==_e.MultiPoint){var s=r||n,l=t.color;"object"===$.type(l)?e.setProperty("color",a(e.getProperty(s))):e.setProperty("color",l),e.setProperty("border",t.border),e.setProperty("width",t.width)}else{var c=t.icon.options[e.getProperty(r)];c||(c=t.icon.path),e.setProperty("icon",c)}e.setProperty("order",t.order)}function a(e,n,t){e.setStyle(i),t.report&&e.addListener("click",function(e){if("function"===t.report){var i=e.feature.getProperty(q(t,0));"string"===$.type(i)&&(i=i.replace(/\s/g,"")),$("#modal-report-"+n+i).modal("show")}else $("#modal-report-"+n).modal("show")}),X[n]=e}function s(e,n,t){$.each(n,function(n,i){i.getVisible()?P(e,i):(w(e,i,t),g(e,ae.hasClass("in"),se.hasClass("in")))})}function l(e){return e.geom===_e.LineString}function c(e){return e.geom===_e.MultiLineString}function u(e){return l(e)||c(e)}function d(e,n,t){var i=n.visible,o=n.time?n.id:e;if("WMS"===n.geom){var r=new $.Deferred,a=new geoambiente.maps.WmsLayer({url:n.url,layer:n.name,visibility:n.visible,opacity:n.transparency,map:K});return r.resolve(a),X[e]=a,i&&U(o,!0),t&&t(a),r.promise()}var s=Publish.path+e+".geojson";return $.getJSON(s,function(r){var a=new google.maps.Data;a.addGeoJson(r),u(n)?x(a,e,n):(C(a,e,n),i&&(a.setMap(K),U(o,!0)),t&&t(a))})}function p(e,n){e.setMap(null),U(n,!1)}function f(e,n){e.setMap(K),U(n,!0),g(n,ae.hasClass("in"),se.hasClass("in"))}function h(e,n,t){if(n=n||Publish.data[e],n.time&&!t)$.each(n.name,function(e,t){h(t,n,!0)});else{var i=X[e];if(i)if(u(n)){var o=n.icon.time;l(n)?s(e,i,o):$.each(i,function(n,t){s(e,t,o)})}else{var r=n.time?n.id:e;Ee[r]?(p(i,r),n.time&&$.each(Ne,D)):f(i,r)}else S(),oe.empty(),k(e,1,1),n.visible=!0,d(e,n).done(function(){g(e,ae.hasClass("in"),se.hasClass("in"))}).always(function(){L()})}}function m(e,n){Q=null,ne.empty(),re.empty(),le.text(" Description"),de.hide(),$("button").removeClass("button-selected"),e&&(le.click(),le.prop("disabled",!0)),n&&(ce.click(),ce.prop("disabled",!0))}function g(e,n,i){Q=e;var o=Publish.data[e];if(t(o,ee[e]),n||(le.prop("disabled",!1),le.click()),i||(ce.prop("disabled",!1),ce.click()),o.download){var r=e+".zip";ue.prop("href",Publish.path+r),ue.prop("download",r),de.show()}else de.hide();$("button").removeClass("button-selected"),$("#"+e).addClass("button-selected")}function v(e){var n=e.target.id;if(n){var t=ae.hasClass("in"),i=se.hasClass("in");Q===n?m(t,i):g(n,t,i)}else{if(!(n=e.target.name))return;var o=Publish.group;if(o){var r=Publish.data[n].group,a=o[r];a?(h(a),a===n?o[r]=null:(o[r]=n,h(n))):(o[r]=n,h(n))}else h(n);if(Je){var s=E();s&&null!==Se?(Se.appendTo(ke),Se=null):s||null!==Se||(Se=Me.detach())}}}function b(e,n,t){var i=0,o=setInterval(function(){i=(i+1)%200;var e=n.get("icons");e[0].offset=i/2+"%",n.set("icons",e)},t);window.intervals||(window.intervals={}),window.intervals[e]||(window.intervals[e]=[]),window.intervals[e].push(o)}function y(e,n){var t=e.icon.options,i=[];n.forEachLatLng(function(e){i.push(e)});var o={path:t.path,anchor:new google.maps.Point(175,175),scale:.1,fillColor:t.fillColor,fillOpacity:t.fillOpacity,strokeWeight:t.strokeWeight},r={path:i,icons:[{icon:o}],strokeWeight:e.width,strokeColor:e.border||e.color,strokeOpacity:e.transparency};return new google.maps.Polyline(r)}function w(e,n,t){n.setMap(K),n.setVisible(!0),b(e,n,t)}function P(e,n){n.setMap(null),n.setVisible(!1),window.intervals&&$.each(window.intervals[e],function(e,n){clearInterval(n)})}function x(e,n,t){var i=[],o=t.visible,r=t.icon.time;e.forEach(function(e){var a=e.getGeometry();if(l(t)){var s=y(t,a);i.push(s),o&&w(n,s,r)}else if(c(t)){var u=[];$.each(a.getArray(),function(e,i){var a=y(t,i);u.push(a),o&&w(n,a,r)}),i.push(u)}}),X[n]=i,o&&U(n,!0)}function C(e,n,t){e.forEach(function(e){r(e,n,t)}),a(e,n,t)}function M(e,n,t){return"Loading"+ee[e]+" ("+n+"/"+t+")"}function k(e,n,t){var i=M(e,n,t);oe.text(i)}function S(){te.fadeIn(),ie.css("z-index",1e7)}function L(){te.fadeOut(),oe.empty(),ie.css("z-index",-1)}function O(e,n){function t(e,n,t){return Math.floor(Math.log(e/n/t)/Math.LN2)}if("number"===$.type(e))return e;var i=t(Ge,e.yTile,e.latFraction),o=t(ye.width(),e.xTile,e.longFraction);return Math.min(i,o,n)}function z(e){var n=[];return $.each(e,function(e,t){n.push(t)}),n}function T(e){var n=[],t=0,i=Object.keys(e).length,o=!1;S(),$.each(e,function(e,s){A(s);var l=s.visible,c=s.time;if(!l&&!c)return!0;if(t+=1,oe.empty(),k(e,t,i),c){var u=0;if("creation"===c){var p=Publish.path+e+".geojson";n.push($.getJSON(p,function(n){var t=new google.maps.Data;t.addGeoJson(n);var i={};$.each(s.timeline,function(e,n){i[n]=new google.maps.Data});var o=s.name;t.forEach(function(n){r(n,e,s);var t=n.getProperty(o),a=i[t];a&&a.add(n)}),s.name=[],$.each(i,function(n,t){var i=e+"_"+n;a(t,i,s),H(n,t,e,c),s.name.push(i),u++,l&&(t.setMap(K),U(e,!0))})}))}else $.each(s.name,function(t,i){var o=s.timeline[u];n.push(d(i,s,function(n){H(o,n,e,c)})),u++});!Je&&l&&(Je=!0,o=!0)}else n.push(d(e,s))});var s=ae.hasClass("in"),l=se.hasClass("in");g(Pe.find(":button")[0].id,s,l),$.when.apply($,n).always(function(){o&&Je&&(W(),Ye.timelineYears=z(Ne),Ye.timelineLayers=z(He),Ye.backup=z(Ne)),L()})}function I(){google.maps.visualRefresh=!0;var e={center:new google.maps.LatLng(Publish.center.lat,Publish.center.long),zoom:O(Publish.zoom,Publish.maxZoom),minZoom:Publish.minZoom,maxZoom:Publish.maxZoom,mapTypeId:google.maps.MapTypeId[Publish.mapTypeId],mapTypeControl:!0,mapTypeControlOptions:{style:google.maps.MapTypeControlStyle.DROPDOWN_MENU,position:google.maps.ControlPosition.TOP_RIGHT}};K=new google.maps.Map(ye[0],e),K.controls[google.maps.ControlPosition.BOTTOM_RIGHT].push($("#footer")[0]),_(),google.maps.event.addListenerOnce(K,"idle",function(){T(Publish.data)})}function W(){Ce.slider({range:!0,min:0,max:Ne.length-1,step:1,values:[0,Ne.length-1]}).each(G).on("slide",V)}function D(e){$.each(He,function(n,t){var i=null;Ee[t.type]&&t.year===Ne[e]&&(i=K),t.layer.setMap(i)})}function V(e,n){var t=Ne.length-1,i=n.values[1]/t*100||0;Le.css("left",i+"%"),je=n.values,D(n.values[1])}function G(){var e=0,n=Ne.length,t=n-1;je=[0,t],0===t&&($sliderHandle=$(".ui-slider-handle"),$($sliderHandle[0]).css("left","0%"),$($sliderHandle[1]).css("left","100%")),$.each(Ne,function(n,i){var o=e/t*100||0,r=$("<label>"+i+"</label>").css("left",o+"%");Ce.append(r),e++})}function H(e,n,t,i,o){var r=Y(e),a=j(e);r?N(t,n,e,i,o):(Ne.splice(a,0,e),N(t,n,e,i,o))}function N(e,n,t,i,o){He.push({type:e,layer:n,year:t,time:i,scenario:o})}function j(e){var n=0;return $.each(Ne,function(t,i){return i===e?t:e<i?t:void n++}),n}function E(){var e=!1;return Je&&He.length>0&&$.each(He,function(n,t){if(Ee[t.type])return e=!0,!1}),e}function Y(e){var n=!1;return $.each(Ne,function(t,i){i===e&&(n=!0)}),n}function Z(){xe.prop("disabled",!0),Ce.slider("disable");var e=Ne.length-1,n=je[0],t=null;t=setInterval(function(){n<=je[1]?(Le.css("left",n/e*100+"%"),D(n),n++):(clearInterval(t),xe.prop("disabled",!1),Ce.slider("enable"))},1e3)}function J(){if(Ye.currentScenario){var e=Publish.data[Ye.currentView],n=e.scenario[Ye.currentScenario];$.each(n.name,function(e,n){X[n].setMap(null)}),Ne=z(Ye.timelineYears),He=z(Ye.timelineLayers),Ye.currentScenario=null,Ye.currentView=null}}function R(){J();var e=$("#scenarioSeparator"),n=Oe.find("option:selected").text(),t=Oe.find("option:selected").val();if(t){0===e.length&&(e=$('<br id="scenarioSeparator"/>'),e.insertBefore(ze));var i=Ze[n];if(i)Ne=z(i.timelineYears),He=z(i.timelineLayers),Ye.currentScenario=n,Ye.currentView=t,Ce.find("label").remove(),W();else{var o=[],r=Publish.data[t],a=r.scenario[n];S(),oe.empty(),k(n,1,1);var s=0,l=r.time;$.each(a.name,function(e,i){var c=a.timeline[s];o.push(d(i,r,function(e){H(c,e,t,l,n)})),s++,Re||(Re=!0)}),$.when.apply($,o).always(function(){Ye.currentScenario=n,Ye.currentView=t,Ze[n]={timelineYears:z(Ne),timelineLayers:z(He)},Ce.find("label").remove(),W(),L(),$.each(Ne,D)})}var c=Publish.scenario[n],u=c.split("."),p=u[0]?u[0]+".":"";u.length-1>1?Te.show():Te.hide(),ze.text(p),We.text(" "+n),De.text(c)}else $.each(Ne,D),Ce.find("label").remove(),W(),e.length>0&&e.remove(),ze.text(""),Te.hide()}function _(){var e=Pe.find(":button");e.each(function(e,n){ee[n.id]=n.innerText,Ee[n.id]=!1}),e.click(v),xe.click(Z),Oe.change(R),le.prop("disabled",!0),ce.prop("disabled",!0),de.hide()}function F(){if(pe.is(":visible"))ye.find(".ol-zoom").css("margin-left",0).removeClass("zoom-top-opened-sidebar").addClass("zoom-top-collapsed");else{var e=$(".sidebar-left");ye.find(".ol-zoom").css("margin-left",e.width()).removeClass("zoom-top-opened-sidebar").removeClass("zoom-top-collapsed")}}function B(){return fe.width()===$(window).width()}function A(e){if(!e.label){e.label={};e.label[e.id]=e.color||e.border||"rgba(0, 0, 0, 1)"}}function U(e,n){Ee[e]!==n&&(Ee[e]=n,Je&&e===Ye.currentView&&Oe.val("").change(),$("#"+e).children("input").prop("checked",n))}function q(e,n){return"array"===$.type(e.select)?e.select[n]:e.select}var K,Q,X={},ee={},ne=$("#legend"),te=$("#loader"),ie=$("#loader-message"),oe=$("#loader-message-text"),re=$("#layer-description"),ae=$("#properties"),se=$("#legends"),le=$("#description-title"),ce=$("#legend-title"),ue=$("#download-title"),de=$("#panel-download"),pe=$(".mini-submenu-left"),fe=$(".sidebar"),he=$(".sidebar-left .sidebar-body"),me=$(".sidebar-left .slide-submenu"),ge=$("#modal-app-description"),ve=$("#modal-completed-description"),$e=$("#modal-title-description"),be=$("#info-description"),ye=$("#map"),we=$("#more"),Pe=$("#layers"),xe=$("#play"),Ce=$("#slider"),Me=$("#slider-container"),ke=$("#slider-col"),Se=null,Le=$("#spanSelectedYear"),Oe=$("#scenario-combobox"),ze=$("#scenario-description"),Te=$("#more-scenario-description"),Ie=$("#modal-scenario-completed-description"),We=$("#modal-scenario-title-description"),De=$("#scenario-info-description"),Ve=$(".navbar").height(),Ge=ye.height(),He=[],Ne=[],je=[],Ee={},Ye={},Ze={},Je=!1,Re=!1,_e={Point:"Point",MultiPoint:"MultiPoint",LineString:"LineString",MultiLineString:"MultiLineString",WMS:"WMS"};google.maps.event.addDomListener(window,"load",I),me.on("click",function(){$(this).closest(".sidebar-body").fadeOut("slide",function(){pe.fadeIn(),F()})}),pe.on("click",function(){var e=$(this);he.toggle("slide"),e.hide(),F()}),we.on("click",function(){ve.modal("show")}),Te.on("click",function(){Ie.modal("show")}),$(window).on("resize",F),ge.modal("show"),function(){if(B()&&(he.fadeOut("slide"),pe.fadeIn()),$("#logo")){var e=Ve-50;$("body").css("padding-top",e),pe.css("margin-top",e)}var n=Publish.fontSize;if(n){var t=$(".custom-font-layer"),i=$(".custom-font-app-title"),o=$(".custom-font-group-title"),r=$(".custom-font-report-title"),a=$(".custom-font-subtitle"),s=$(".custom-font-body"),l=$(".custom-font-legend"),c=$(".custom-font-more "),u=function(e){return parseFloat(e.css("font-size"))},d=function(e,n){e.css("font-size",n+"px")},p=u(t),f=function(e){var t=u(e)-p;d(e,n+t)};d(t,n),f(i),f(o),f(r),f(a),f(s),f(l),f(c)}}(),F()});