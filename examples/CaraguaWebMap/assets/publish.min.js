$(function(){function e(e,o,i){var n=$('<div style="height:25px;">');o.endsWith(".png")?n.append($('<div class="legend-img-box">').css("background-image","url("+o+")")):n.append($('<div class="legend-color-box">').css({backgroundColor:o})),n.append($("<span>").css("lineHeight","23px").html(i)),e.append(n)}function o(o){T.empty(),J.text(" "+Publish.legend);var i=[];$.each(o,function(e){i.push(e)}),i.sort(),$.each(i,function(i,n){var t=o[n];e(T,t,n)})}function i(e,i){var n=e.label,t=i||"Description";B.text(" "+t),G.text(e.description||""),o(n)}function n(e){return{fillColor:e.getProperty("color"),strokeColor:e.getProperty("border"),strokeWeight:e.getProperty("width"),zIndex:e.getProperty("order"),icon:e.getProperty("icon")}}function t(e,o,i){i=i||e.getGeometry();var n=o.geom||i.getType(),t=O(o,1);if(!o.icon||"Point"!==n&&"MultiPoint"!==n){var a=t||o.id,r=o.color;"object"==$.type(r)?e.setProperty("color",r[e.getProperty(a)]):e.setProperty("color",r),e.setProperty("border",o.border),e.setProperty("width",o.width)}else{var s=o.icon.options[e.getProperty(t)];s||(s=o.icon.path),e.setProperty("icon",s)}return e.setProperty("order",o.order),i}function a(e,o){var i=o.id;e.setStyle(n),e.addListener("click",function(e){if(!o.geom||"Point"!==o.geom&&"MultiPoint"!==o.geom)$("#modal-report-"+i).modal("show");else{var n=e.feature.getProperty(O(o,0));"string"==$.type(n)&&(n=n.replace(/\s/g,"-")),$("#modal-report-"+i+n).modal("show")}}),z[i]=e}function r(e,o,i){$.each(o,function(o,n){n.getVisible()?m(e,n):(f(e,n,i),d(e,E.hasClass("in"),W.hasClass("in")))})}function s(e){var o=z[e],i=Publish.data[e];if(o)if("LineString"===i.geom||"MultiLineString"===i.geom){var n=i.icon.time;"LineString"===i.geom?r(i.id,o,n):$.each(o,function(e,o){r(i.id,o,n)})}else o.getMap()?(o.setMap(null),M(e,!1)):(o.setMap(x),M(e,!0),d(e,E.hasClass("in"),W.hasClass("in")));else{D.fadeIn();var t=Publish.path+e+".geojson";$.getJSON(t,function(n){o=new google.maps.Data,L(i),o.addGeoJson(n),"LineString"===i.geom||"MultiLineString"===i.geom?h(o,i):(b(o,i),o.setMap(x)),M(e,!0),d(e,E.hasClass("in"),W.hasClass("in"))}).always(function(){D.fadeOut()})}return e}function l(e,o){S.layer=null,T.empty(),G.empty(),B.text(" Description"),R.hide(),e&&(B.click(),B.prop("disabled",!0)),o&&(J.click(),J.prop("disabled",!0))}function d(e,o,n){S.layer=e;var t=Publish.data[e];if(i(t,I[e]),o||(B.prop("disabled",!1),B.click()),n||(J.prop("disabled",!1),J.click()),t.download){var a=e+".zip";N.prop("href",Publish.path+a),N.prop("download",a),R.show()}else R.hide()}function p(e){var o=e.target.id;if(o){var i=E.hasClass("in"),n=W.hasClass("in");S.layer===o?l(i,n):d(o,i,n)}else e.target.name&&s(e.target.name)}function c(e){var o=e.target.id.replace("group-",""),i=Publish.group,n=i[o];n&&(S.group?S.group===o&&(S.group=null,$.each(i,function(e){$("#group-"+e).prop("disabled",!1)})):(S.group=o,$.each(i,function(e){e!==o&&$("#group-"+e).prop("disabled",!0)})))}function u(e,o,i){var n=0,t=setInterval(function(){n=(n+1)%200;var e=o.get("icons");e[0].offset=n/2+"%",o.set("icons",e)},i);window.intervals||(window.intervals={}),window.intervals[e]||(window.intervals[e]=[]),window.intervals[e].push(t)}function g(e,o){var i=e.icon.options,n=[];o.forEachLatLng(function(e){n.push(e)});var t={path:i.path,anchor:new google.maps.Point(175,175),scale:.1,fillColor:i.fillColor,fillOpacity:i.fillOpacity,strokeWeight:i.strokeWeight},a={path:n,icons:[{icon:t}],strokeWeight:e.width,strokeColor:e.border||e.color,strokeOpacity:e.transparency};return new google.maps.Polyline(a)}function f(e,o,i){o.setMap(x),o.setVisible(!0),u(e,o,i)}function m(e,o){o.setMap(null),o.setVisible(!1),window.intervals&&$.each(window.intervals[e],function(e,o){clearInterval(o)})}function h(e,o){var i=[],n=o.visible,t=o.icon.time;e.forEach(function(e){var a=e.getGeometry();if("LineString"==o.geom){var r=g(o,a);i.push(r),n&&f(o.id,r,t)}else if("MultiLineString"==o.geom){var s=[];$.each(a.getArray(),function(e,i){var a=g(o,i);s.push(a),n&&f(o.id,a,t)}),i.push(s)}}),z[o.id]=i,n&&M(o.id,!0)}function b(e,o,i){e.forEach(function(e){var n=e.getGeometry();t(e,o,n),i&&i(n)}),a(e,o)}function v(e){var o=[],i=new google.maps.LatLngBounds;D.fadeIn(),$.each(e,function(e,n){L(n);var t=Publish.path+e+".geojson";o.push($.getJSON(t,function(e){var o=new google.maps.Data;o.addGeoJson(e),"LineString"===n.geom||"MultiLineString"===n.geom?h(o,n):(b(o,n,function(e){e.forEachLatLng(function(e){i.extend(e)})}),n.visible&&(o.setMap(x),M(n.id,!0)))}))}),$.when.apply($,o).done(function(){x.fitBounds(i)}).always(function(){D.fadeOut()})}function y(){var e=$("#layers"),o=e.find(":button");o.each(function(e,o){I[o.id]=o.innerText}),o.click(p),B.prop("disabled",!0),J.prop("disabled",!0),R.hide();var i=e.find(":link");i.click(c)}function w(){google.maps.visualRefresh=!0;var e={minZoom:Publish.minZoom,maxZoom:Publish.maxZoom,mapTypeId:google.maps.MapTypeId[Publish.mapTypeId],mapTypeControl:!0,mapTypeControlOptions:{style:google.maps.MapTypeControlStyle.DROPDOWN_MENU,position:google.maps.ControlPosition.TOP_RIGHT}};Publish.center&&(e.center=new google.maps.LatLng(Publish.center.lat,Publish.center.long)),Publish.zoom&&(e.zoom=Publish.zoom);var o=document.getElementById("map");x=new google.maps.Map(o,e),x.controls[google.maps.ControlPosition.BOTTOM_RIGHT].push($("#footer")[0]),Publish.zoom||google.maps.event.addListenerOnce(x,"idle",function(){v(Publish.data)}),y()}function P(){var e=$(".mini-submenu-left");e.is(":visible")?$("#map").find(".ol-zoom").css("margin-left",0).removeClass("zoom-top-opened-sidebar").addClass("zoom-top-collapsed"):$("#map").find(".ol-zoom").css("margin-left",$(".sidebar-left").width()).removeClass("zoom-top-opened-sidebar").removeClass("zoom-top-collapsed")}function C(){return $(".sidebar").width()==$(window).width()}function k(){C()&&($(".sidebar-left .sidebar-body").fadeOut("slide"),$(".mini-submenu-left").fadeIn())}function L(e){e.label||(e.label={},e.label[e.id]=e.color||e.border)}function M(e,o){$("#"+e).children("input").prop("checked",o)}function O(e,o){return"array"==$.type(e.select)?e.select[o]:e.select}var x,z={},I={},S={},T=$("#legend"),D=$("#loader"),G=$("#layer-description"),E=$("#properties"),W=$("#legends"),B=$("#description-title"),J=$("#legend-title"),N=$("#download-title"),R=$("#panel-download");google.maps.event.addDomListener(window,"load",w),$(".sidebar-left .slide-submenu").on("click",function(){var e=$(this);e.closest(".sidebar-body").fadeOut("slide",function(){$(".mini-submenu-left").fadeIn(),P()})}),$(".mini-submenu-left").on("click",function(){var e=$(this);$(".sidebar-left .sidebar-body").toggle("slide"),e.hide(),P()}),$(window).on("resize",P),$("#modal-app-description").modal("show"),k(),P()});