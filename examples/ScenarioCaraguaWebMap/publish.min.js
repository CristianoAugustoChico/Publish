$(function(){function e(e,n,t){var i=$('<div style="height:25px;">');n.endsWith(".png")?i.append($('<div class="legend-img-box">').css("background-image","url("+n+")")):i.append($('<div class="legend-color-box">').css({backgroundColor:n})),i.append($("<span>").css("lineHeight","23px").html(t)),e.append(i)}function n(n){re.empty(),he.text(" "+Publish.legend);var t=[];$.each(n,function(e){t.push(e)}),t.sort(),$.each(t,function(t,i){var o=n[i];e(re,o,i)})}function t(e,t){var i=e.label,o=t||"Description",a=e.description||"",r=a.split("."),s=r[0]?r[0]+".":"",l=Re+40,c=40*(_e-l)/100,u=20*(_e-l)/100;Se.height()<c&&(u=30*(_e-l)/100),Se.css("max-height",c),de.css("max-height",u),pe.css("max-height",u),r.length-1>1?Me.show():Me.hide(),fe.text(" "+o),ue.text(s),xe.text(" "+o),Ce.text(a),n(i)}function i(e){return{fillColor:e.getProperty("color"),strokeColor:e.getProperty("border"),strokeWeight:e.getProperty("width"),zIndex:e.getProperty("order"),icon:e.getProperty("icon")}}function o(e){var n=e.color;if(e.slices){var t=Object.keys(n).sort(function(e,n){return e-n}),i=t.map(Number);return function(e){var o=null;return $.each(i,function(i,a){e>=a&&(o=n[t[i]])}),o}}return function(e){return n[e]}}function a(e,n,t){var i=t.geom||e.getGeometry().getType(),a=ne(t,1),r=o(t);if(!t.icon||i!==nn.Point&&i!==nn.MultiPoint){var s=a||n,l=t.color;"object"===$.type(l)?e.setProperty("color",r(e.getProperty(s))):e.setProperty("color",l),e.setProperty("border",t.border),e.setProperty("width",t.width)}else{var c=t.icon.options[e.getProperty(a)];c||(c=t.icon.path),e.setProperty("icon",c)}e.setProperty("order",t.order)}function r(e,n,t){e.setStyle(i),t.report&&e.addListener("click",function(e){if("function"===t.report){var i=e.feature.getProperty(ne(t,0));"string"===$.type(i)&&(i=i.replace(/\s/g,"")),$("#modal-report-"+n+i).modal("show")}else $("#modal-report-"+n).modal("show")}),oe[n]=e}function s(e,n,t){$.each(n,function(n,i){i.getVisible()?M(e,i):(k(e,i,t),y(e,de.hasClass("in"),pe.hasClass("in")))})}function l(e){return e.geom===nn.LineString}function c(e){return e.geom===nn.MultiLineString}function u(e){return l(e)||c(e)}function d(e,n,t){var i=n.visible,o=n.time?n.id:e;if("WMS"===n.geom){var a=new $.Deferred,r=n.time?e:n.name,s=new geoambiente.maps.WmsLayer({url:n.url,layer:r,visibility:i,opacity:n.transparency,map:te});return a.resolve(s),oe[e]=s,i&&ee(o,!0),t&&t(s),a.promise()}var l=Publish.path+e+".geojson";return $.getJSON(l,function(a){var r=new google.maps.Data;r.addGeoJson(a),u(n)?S(r,e,n):(L(r,e,n),i&&(r.setMap(te),ee(o,!0)),t&&t(r))})}function p(e,n){e.setMap(null),ee(n,!1)}function f(e,n){e.setMap(te),ee(n,!0),y(n,de.hasClass("in"),pe.hasClass("in"))}function h(e,n,t){var i=e.icon.time;l(e)?s(n,t,i):$.each(t,function(e,t){s(n,t,i)})}function m(e,n){Ae[e]?p(n,e):f(n,e)}function g(e){Ae[e]?ee(e,!1):(ee(e,!0),y(e,de.hasClass("in"),pe.hasClass("in"))),$.each(He,j)}function v(e){var n=Publish.data[e];if(n.time)g(e);else{var t=oe[e];t?u(n)?h(n,e,t):m(e,t):(T(),ce.empty(),z(e,1,1),n.visible=!0,d(e,n).done(function(){y(e,de.hasClass("in"),pe.hasClass("in"))}).always(function(){I()}))}}function b(e,n){ie=null,re.empty(),ue.empty(),fe.text(" Description"),ge.hide(),$("button").removeClass("button-selected"),e&&(fe.click(),fe.prop("disabled",!0)),n&&(he.click(),he.prop("disabled",!0))}function y(e,n,i){ie=e;var o=Publish.data[e];if(t(o,ae[e]),n||(fe.prop("disabled",!1),fe.click()),i||(he.prop("disabled",!1),he.click()),o.download){var a=e+".zip";me.prop("href",Publish.path+a),me.prop("download",a),ge.show()}else ge.hide();ze.removeClass("button-selected"),$("#"+e).addClass("button-selected")}function w(e){var n=e.target.id;if(n){var t=de.hasClass("in"),i=pe.hasClass("in");ie===n?b(t,i):y(n,t,i)}}function P(e){var n=e.target.name;if(n){var t=Publish.group;if(t){var i=Publish.data[n].group,o=t[i];o?(v(o),o===n?t[i]=null:(t[i]=n,v(n))):(t[i]=n,v(n))}else v(n);if(Xe){var a=_();a&&null!==Ve?(Ve.appendTo(De),Ve=null):a||null!==Ve||(Ve=We.detach())}}}function x(e,n,t){var i=0,o=setInterval(function(){i=(i+1)%200;var e=n.get("icons");e[0].offset=i/2+"%",n.set("icons",e)},t);window.intervals||(window.intervals={}),window.intervals[e]||(window.intervals[e]=[]),window.intervals[e].push(o)}function C(e,n){var t=e.icon.options,i=[];n.forEachLatLng(function(e){i.push(e)});var o={path:t.path,anchor:new google.maps.Point(175,175),scale:.1,fillColor:t.fillColor,fillOpacity:t.fillOpacity,strokeWeight:t.strokeWeight},a={path:i,icons:[{icon:o}],strokeWeight:e.width,strokeColor:e.border||e.color,strokeOpacity:e.transparency};return new google.maps.Polyline(a)}function k(e,n,t){n.setMap(te),n.setVisible(!0),x(e,n,t)}function M(e,n){n.setMap(null),n.setVisible(!1),window.intervals&&$.each(window.intervals[e],function(e,n){clearInterval(n)})}function S(e,n,t){var i=[],o=t.visible,a=t.icon.time;e.forEach(function(e){var r=e.getGeometry();if(l(t)){var s=C(t,r);i.push(s),o&&k(n,s,a)}else if(c(t)){var u=[];$.each(r.getArray(),function(e,i){var r=C(t,i);u.push(r),o&&k(n,r,a)}),i.push(u)}}),oe[n]=i,o&&ee(n,!0)}function L(e,n,t){e.forEach(function(e){a(e,n,t)}),r(e,n,t)}function O(e,n,t){return"Loading"+ae[e]+" ("+n+"/"+t+")"}function z(e,n,t){var i=O(e,n,t);ce.text(i)}function T(){se.fadeIn(),le.css("z-index",1e7)}function I(){se.fadeOut(),ce.empty(),le.css("z-index",-1)}function W(e,n){function t(e,n,t){return Math.floor(Math.log(e/n/t)/Math.LN2)}if("number"===$.type(e))return e;var i=t(_e,e.yTile,e.latFraction),o=t(ke.width(),e.xTile,e.longFraction);return Math.min(i,o,n)}function D(e){var n=[];return $.each(e,function(e,t){n.push(t)}),n}function V(e){var n=[],t=0,i=Object.keys(e).length,o=!1;T(),$.each(e,function(e,s){X(s);var l=s.visible,c=s.time;if(s.scenario&&(qe[e]=!0,en||(en=!0)),!l&&!c)return!0;if(t+=1,ce.empty(),z(e,t,i),c){var u=0;if("creation"===c){var p=Publish.path+e+".geojson";n.push($.getJSON(p,function(n){var t=new google.maps.Data;t.addGeoJson(n);var i={};$.each(s.timeline,function(e,n){i[n]=new google.maps.Data});var o=s.name;t.forEach(function(n){a(n,e,s);var t=n.getProperty(o),r=i[t];r&&r.add(n)}),s.name=[],$.each(i,function(n,t){var i=e+"_"+n;r(t,i,s),Z(n,t,e,c),s.name.push(i),u++,l&&(t.setMap(te),ee(e,!0))})}))}else $.each(s.name,function(t,i){var o=s.timeline[u];n.push(d(i,s,function(n){Z(o,n,e,c)})),u++});!Xe&&l&&(Xe=!0,o=!0)}else n.push(d(e,s))});var s=de.hasClass("in"),l=pe.hasClass("in");y(ze[0].id,s,l),$.when.apply($,n).always(function(){o&&Xe&&(N(),Ke.timelineYears=D(He),Ke.timelineLayers=D(Fe),Ke.backup=D(He)),I()})}function G(){google.maps.visualRefresh=!0;var e={center:new google.maps.LatLng(Publish.center.lat,Publish.center.long),zoom:W(Publish.zoom,Publish.maxZoom),minZoom:Publish.minZoom,maxZoom:Publish.maxZoom,mapTypeId:google.maps.MapTypeId[Publish.mapTypeId],mapTypeControl:!0,mapTypeControlOptions:{style:google.maps.MapTypeControlStyle.DROPDOWN_MENU,position:google.maps.ControlPosition.TOP_RIGHT}};te=new google.maps.Map(ke[0],e),te.controls[google.maps.ControlPosition.BOTTOM_RIGHT].push($("#footer")[0]),q(),google.maps.event.addListenerOnce(te,"idle",function(){V(Publish.data)})}function N(){Ie.slider({range:!0,min:0,max:He.length-1,step:1,values:[0,He.length-1]}).each(Y).on("slide",E)}function j(e){$.each(Fe,function(n,t){var i=null;Ae[t.type]&&t.year===He[e]&&(i=te),t.layer.setMap(i)})}function E(e,n){var t=He.length-1,i=n.values[1]/t*100-1||0;Ge.css("left",i+"%"),Be=n.values,j(n.values[1])}function Y(){var e=0,n=He.length,t=n-1;if(Be=[0,t],0===t){var i=$(".ui-slider-handle");$(i[0]).css("left","0%"),$(i[1]).css("left","100%");var o=$("<label> </label>").css("left","0%");Ie.append(o),o=$("<label>"+He[0]+"</label>").css("left","100%"),Ie.append(o)}else $.each(He,function(n,i){var o=e/t*100||0,a=$("<label>"+i+"</label>").css("left",o+"%");Ie.append(a),e++});if(n>0){var a=100/n;if(a<6){var r=.6*ke.width(),s=We.width(),l=s*(6/a);l>r&&(l=r),We.width(l)}}}function Z(e,n,t,i,o){var a=F(e),r=R(e);a?J(t,n,e,i,o):(He.splice(r,0,e),J(t,n,e,i,o))}function J(e,n,t,i,o){Fe.push({type:e,layer:n,year:t,time:i,scenario:o})}function R(e){var n=0;return $.each(He,function(t,i){return i===e?t:e<i?t:void n++}),n}function _(){var e=!1;return Xe&&Fe.length>0&&$.each(Fe,function(n,t){if(Ae[t.type])return e=!0,!1}),e}function F(e){var n=!1;return $.each(He,function(t,i){i===e&&(n=!0)}),n}function H(){Oe.prop("disabled",!0),ze.off("click"),Te.prop("disabled",!0),Ie.slider("disable");var e=He.length-1,n=Be[0],t=null;t=setInterval(function(){n<=Be[1]?(Ge.css("left",n/e*100-1+"%"),j(n),n++):(clearInterval(t),Oe.prop("disabled",!1),ze.click(w),Te.prop("disabled",!1),Ie.slider("enable"))},1e3)}function B(){var e=!1;return en&&$.each(Ae,function(n,t){if(t&&qe[n])return e=!0,!1}),e}function A(){if(Ke.currentScenario){var e=Publish.data[Ke.currentView],n=e.scenario[Ke.currentScenario];$.each(n.name,function(e,n){oe[n].setMap(null)}),He=D(Ke.timelineYears),Fe=D(Ke.timelineLayers),Ke.currentScenario=null,Ke.currentView=null}}function U(){A();var e=$("#scenarioSeparator"),n=Ne.find("option:selected").text(),t=Ne.find("option:selected").val();if(t){0===e.length&&(e=$('<br id="scenarioSeparator"/>'),e.insertBefore(je));var i=Qe[n];if(i)He=D(i.timelineYears),Fe=D(i.timelineLayers),Ke.currentScenario=n,Ke.currentView=t,Ie.find("label").remove(),N();else{var o=[],a=Publish.data[t],r=a.scenario[n];T(),ce.empty(),z(n,1,1);var s=0,l=a.time;$.each(r.name,function(e,i){var c=r.timeline[s];o.push(d(i,a,function(e){Z(c,e,t,l,n)})),s++}),$.when.apply($,o).always(function(){Ke.currentScenario=n,Ke.currentView=t,Qe[n]={timelineYears:D(He),timelineLayers:D(Fe)},Ie.find("label").remove(),N(),I(),$.each(He,j)})}var c=Publish.scenario[n],u=c.split("."),p=u[0]?u[0]+".":"";u.length-1>1?Ee.show():Ee.hide(),je.text(p),Ze.text(" "+n),Je.text(c)}else $.each(He,j),Ie.find("label").remove(),N(),e.length>0&&e.remove(),je.text(""),Ee.hide()}function q(){Oe.each(function(e,n){Ue[n.name]=$(n)}),ze.each(function(e,n){ae[n.id]=n.innerText,Ae[n.id]=!1}),Oe.click(P),ze.click(w),Te.click(H),Ne.change(U),fe.prop("disabled",!0),he.prop("disabled",!0),ge.hide()}function K(){if(ve.is(":visible"))ke.find(".ol-zoom").css("margin-left",0).removeClass("zoom-top-opened-sidebar").addClass("zoom-top-collapsed");else{var e=$(".sidebar-left");ke.find(".ol-zoom").css("margin-left",e.width()).removeClass("zoom-top-opened-sidebar").removeClass("zoom-top-collapsed")}}function Q(){return $e.width()===$(window).width()}function X(e){if(!e.label){e.label={};e.label[e.id]=e.color||e.border||"rgba(0, 0, 0, 1)"}}function ee(e,n){Ae[e]!==n&&(Ae[e]=n,en&&e===Ke.currentView&&Ne.val("").change(),Ue[e].prop("checked",n)),en&&(B()?Ne.prop("disabled",!1):Ne.prop("disabled",!0))}function ne(e,n){return"array"===$.type(e.select)?e.select[n]:e.select}var te,ie,oe={},ae={},re=$("#legend"),se=$("#loader"),le=$("#loader-message"),ce=$("#loader-message-text"),ue=$("#layer-description"),de=$("#properties"),pe=$("#legends"),fe=$("#description-title"),he=$("#legend-title"),me=$("#download-title"),ge=$("#panel-download"),ve=$(".mini-submenu-left"),$e=$(".sidebar"),be=$(".sidebar-left .sidebar-body"),ye=$(".sidebar-left .slide-submenu"),we=$("#modal-app-description"),Pe=$("#modal-completed-description"),xe=$("#modal-title-description"),Ce=$("#info-description"),ke=$("#map"),Me=$("#more"),Se=$("#layers"),Le=Se.find("label"),Oe=Le.find("input"),ze=Le.find("a"),Te=$("#play"),Ie=$("#slider"),We=$("#slider-container"),De=$("#slider-col"),Ve=null,Ge=$("#spanSelectedYear"),Ne=$("#scenario-combobox"),je=$("#scenario-description"),Ee=$("#more-scenario-description"),Ye=$("#modal-scenario-completed-description"),Ze=$("#modal-scenario-title-description"),Je=$("#scenario-info-description"),Re=$(".navbar").height(),_e=ke.height(),Fe=[],He=[],Be=[],Ae={},Ue={},qe={},Ke={},Qe={},Xe=!1,en=!1,nn={Point:"Point",MultiPoint:"MultiPoint",LineString:"LineString",MultiLineString:"MultiLineString",WMS:"WMS"};google.maps.event.addDomListener(window,"load",G),ye.on("click",function(){$(this).closest(".sidebar-body").fadeOut("slide",function(){ve.fadeIn(),K()})}),ve.on("click",function(){var e=$(this);be.toggle("slide"),e.hide(),K()}),Me.on("click",function(){Pe.modal("show")}),Ee.on("click",function(){Ye.modal("show")}),$(window).on("resize",K),we.modal("show"),function(){if(Q()&&(be.fadeOut("slide"),ve.fadeIn()),$("#logo")){var e=Re-50;$("body").css("padding-top",e),ve.css("margin-top",e)}var n=Publish.fontSize;if(n){var t=$(".custom-font-layer"),i=$(".custom-font-app-title"),o=$(".custom-font-group-title"),a=$(".custom-font-report-title"),r=$(".custom-font-subtitle"),s=$(".custom-font-body"),l=$(".custom-font-legend"),c=$(".custom-font-more "),u=function(e){return parseFloat(e.css("font-size"))},d=function(e,n){e.css("font-size",n+"px")},p=u(t),f=function(e){var t=u(e)-p;d(e,n+t)};d(t,n),f(i),f(o),f(a),f(r),f(s),f(l),f(c)}}(),K()});